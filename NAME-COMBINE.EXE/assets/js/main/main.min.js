document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("input"),t=document.getElementById("line-numbers"),n=document.getElementById("generate"),o=document.getElementById("fix-input"),a=document.getElementById("reset-system"),s=document.getElementById("error-section"),i=document.getElementById("error-list"),c=document.getElementById("output-info"),l=document.getElementById("output-message"),r=document.getElementById("total-combinations-display"),d=document.getElementById("post-generation-controls"),u=document.getElementById("download"),m=document.getElementById("open-in-new-tab"),E=document.getElementById("progress-overlay"),g=document.getElementById("donut-chart"),f=document.getElementById("donut-percentage"),p=document.getElementById("overlay-message"),I=document.getElementById("overlay-sub-message"),T="https://combine-exe.mbahbabat.workers.dev";let y=null,C=[],L=0;const h={set:(e,t)=>{try{const n={data:t,timestamp:Date.now()};return localStorage.setItem(e,JSON.stringify(n)),!0}catch(e){return console.warn("LocalStorage set failed:",e),!1}},get:e=>{try{const t=localStorage.getItem(e);if(!t)return null;const n=JSON.parse(t);return Date.now()-n.timestamp>864e5?(localStorage.removeItem(e),null):n.data}catch(e){return console.warn("LocalStorage get failed:",e),null}},remove:e=>{try{return localStorage.removeItem(e),!0}catch(e){return console.warn("LocalStorage remove failed:",e),!1}}};function x(){const n=e.value.split("\n");let o="";for(let e=1;e<=n.length;e++)o+=String(e).padStart(8,"0")+"\n";t.textContent=o,t.scrollTop=e.scrollTop,e.scrollTop=e.scrollHeight}function O(){const a=e.value.trim(),l=[];if(!a)return void v();const r=a.split(/\s+/).filter((e=>""!==e.trim())).map((e=>e.replace(/[^a-zA-Z]/g,""))).filter((e=>""!==e)),d=new Set,u=[];r.forEach((e=>{d.has(e.toLowerCase())?l.push(`DUPLICATE NAME DETECTED: ${e}`):(d.add(e.toLowerCase()),u.push(e))}));const m=a.split(/\s+/).filter((e=>""!==e.trim())),E=[];m.forEach((e=>{e.replace(/[^a-zA-Z]/g,"")!==e&&E.push(e)})),E.length>0&&l.push(`INVALID CHARACTERS IN: ${E.join(", ")}`),l.length>0?(!function(n){i.innerHTML="",n.forEach((e=>{const t=document.createElement("li");t.textContent=e,i.appendChild(t)})),s.classList.remove("hidden"),c.classList.add("hidden"),e.style.cssText="background: #330011; color: red; animation: blink-animation 1s infinite;",t.style.cssText="background: #330011; color: red; animation: blink-animation 0.7s infinite;"}(l),n.classList.add("hidden"),o.classList.remove("hidden")):(v(),n.classList.remove("hidden"),o.classList.add("hidden"))}function v(){s.classList.add("hidden"),c.classList.remove("hidden"),e.style.cssText="",t.style.cssText=""}function N(){const t=e.value.trim();if(!t)return;const o=t.split(/\s+/).filter((e=>""!==e.trim())),a=[],s=new Set;o.forEach((e=>{const t=e.replace(/[^a-zA-Z]/g,"");t&&!s.has(t.toLowerCase())&&(a.push(t),s.add(t.toLowerCase()))})),e.value=a.join("\n"),x(),O(),n.style.cssText="background: #00ffff; color:#000; animation: blink-animation 1s infinite;"}async function w(){C=[],L=0,l.textContent="INITIALIZING EXECUTION...",r.style.display="none",d.style.display="none",e.readOnly=!0,n.style.cssText="",e.style.cssText="opacity:0.5; background: #660033; cursor: not-allowed",t.style.cssText="opacity:0.5; background: none; cursor: not-allowed",E.classList.add("active"),f.textContent="0%",p.textContent="INITIATING EXECUTION PROTOCOL...",I.textContent="";const o=e.value.trim().split(/\s+/).filter((e=>""!==e.trim())).map((e=>e.replace(/[^a-zA-Z]/g,""))).filter((e=>""!==e)),s=Array.from(new Set(o.map((e=>e.toLowerCase())))).map((e=>o.find((t=>t.toLowerCase()===e)))),i=s.length,c=i*(i-1);if(0===c)return p.textContent="NO VALID NAMES FOR COMBINATION.",I.textContent="EXPECTED: 0 COMBINATIONS.",setTimeout((()=>{A(),l.textContent="EXECUTION ABORTED: NO VALID NAMES."}),2e3),void B();let u=h.get("accessToken"),m=h.get("wc");if(!u){const e=await fetch(`${T}/get-accessToken`);if(!e.ok)throw new Error("Failed to get access token from server");u=(await e.json()).accessToken,h.set("accessToken",u)}if(!m){const e=await fetch(`${T}/wc`,{headers:{Authorization:`Bearer ${u}`}});if(!e.ok)throw h.remove("accessToken"),new Error(`Failed to load worker code: ${e.statusText||e.status}`);m=await e.text(),h.set("wc",m)}const g=new Blob([m],{type:"application/javascript"});y=new Worker(URL.createObjectURL(g)),y.onmessage=async function(e){if(e.data.chunk&&e.data.chunk.length>0){n.disabled=!0,a.disabled=!0,C=C.concat(e.data.chunk),L=C.length;const t=Math.round(100*e.data.progress);k(t),p.textContent=`PROCESSING DATA: ${t}% COMPLETE.`,I.textContent=`EXPECTED: ${c.toLocaleString()} COMBINATIONS. CURRENT: ${L.toLocaleString()}`}e.data.done&&(k(100),p.textContent="EXECUTION COMPLETE!",I.textContent=`FINAL COMBINATIONS: ${C.length.toLocaleString()}`,l.textContent="EXECUTION COMPLETE!",r.innerHTML=`TOTAL COMBINATIONS: <span style="color:#ffff00; font-weight: 900; text-shadow: 1px 1px 0px black">${C.length.toLocaleString()}</span>`,r.style.cssText="display: block; animation : blink-animation 1s infinite",d.style.display="flex",a.disabled=!1,y&&(y.terminate(),y=null),setTimeout(A,2e3))},y.onerror=function(n){console.error("Worker error:",n),p.textContent="ERROR: EXECUTION FAILED.",I.textContent="PLEASE REVIEW INPUT AND RETRY.",l.textContent="ERROR: EXECUTION FAILED.",e.readOnly=!1,e.style.cssText="",t.style.cssText="",y&&(y.terminate(),y=null),setTimeout(A,3e3)},y.postMessage({names:s,chunkSize:1e5,delay:0})}async function S(){if(0===L)return;l.textContent="PREPARING DOWNLOAD...";const e=C.join("\n"),t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t),o=document.createElement("a"),a=new Date;o.href=n,o.download=`${L}-Combination-NAME COMBINE.EXE-${a.toLocaleDateString()}-${a.toLocaleTimeString().replace(/:/g,"-")}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),l.textContent="DOWNLOAD INITIATED.",setTimeout((()=>{l.textContent="EXECUTION SUCCESSFUL!"}),2e3)}async function b(){if(0===L)return;l.textContent="ACCESSING RESULTS IN NEW TAB...";const e=C.join("\n"),t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t);window.open(n,"_blank"),setTimeout((()=>{l.textContent="EXECUTION SUCCESSFUL!"}),2e3)}function A(){E.classList.remove("active")}function k(e){g.style.background=`conic-gradient(var(--progress-bar-color) 0% ${e}%, var(--border-color) ${e}% 100%)`,f.textContent=`${e}%`}function B(){e.readOnly=!1,e.style.cssText="",t.style.cssText="",n.disabled=!1,y=null,C=[],L=0,e.value="",l.textContent="AWAITING COMMAND...",r.style.display="none",d.style.display="none",v(),N(),x()}!async function(){n.addEventListener("click",w),a.addEventListener("click",B),o.addEventListener("click",N),u.addEventListener("click",S),m.addEventListener("click",b),e.value="",function(){let t;function n(){let t=e.value.trim().split(/\s+/).filter((e=>e));e.value=t.join("\n"),O(),x()}e.addEventListener("click",(function(){n(),O(),x()})),e.addEventListener("change",(function(){n(),O(),x()})),e.addEventListener("scroll",(function(){n(),O(),x()})),e.addEventListener("blur",(function(){n(),O(),x()})),e.addEventListener("input",(function(){clearTimeout(t),O(),t=setTimeout(n,3e3),x()})),e.addEventListener("paste",(function(e){e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text").trim().split(/\s+/).filter((e=>e)).join("\n"),n=this.selectionStart,o=this.selectionEnd,a=this.value;this.value=a.substring(0,n)+t+a.substring(o),this.setSelectionRange(n+t.length,n+t.length),O(),x()}))}(),x()}()}));
