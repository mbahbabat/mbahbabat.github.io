document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("input"),t=document.getElementById("generate"),n=document.getElementById("fix-input"),o=document.getElementById("reset-system"),a=document.getElementById("error-section"),s=document.getElementById("error-list"),r=document.getElementById("output-info"),c=document.getElementById("output-message"),i=document.getElementById("total-combinations-display"),l=document.getElementById("post-generation-controls"),d=document.getElementById("download"),E=document.getElementById("open-in-new-tab"),u=document.getElementById("progress-overlay"),m=document.getElementById("donut-chart"),I=document.getElementById("donut-percentage"),L=document.getElementById("overlay-message"),g=document.getElementById("overlay-sub-message"),C="https://combine-exe.mbahbabat.workers.dev",CACHE_DURATION = 864e5;let N=null,T=[],p=0;const A=(e,t)=>{try{const n={data:t,timestamp:Date.now()};return localStorage.setItem(e,JSON.stringify(n)),!0}catch(e){return console.warn("LocalStorage set failed:",e),!1}},y=e=>{try{const t=localStorage.getItem(e);if(!t)return null;const n=JSON.parse(t);return Date.now()-n.timestamp>CACHE_DURATION?(localStorage.removeItem(e),null):n.data}catch(e){return console.warn("LocalStorage get failed:",e),null}},f=e=>{try{return localStorage.removeItem(e),!0}catch(e){return console.warn("LocalStorage remove failed:",e),!1}};function h(){const o=e.value.trim(),c=[];if(!o)return void O();const i=o.split(/\s+/).filter((e=>""!==e.trim())).map((e=>e.replace(/[^a-zA-Z]/g,""))).filter((e=>""!==e)),l=new Set,d=[];i.forEach((e=>{l.has(e.toLowerCase())?c.push(`DUPLICATE NAME DETECTED: ${e}`):(l.add(e.toLowerCase()),d.push(e))}));const E=o.split(/\s+/).filter((e=>""!==e.trim())),u=[];E.forEach((e=>{e.replace(/[^a-zA-Z]/g,"")!==e&&u.push(e)})),u.length>0&&c.push(`INVALID CHARACTERS IN: ${u.join(", ")}`),c.length>0?(function(e){s.innerHTML="",e.forEach((e=>{const t=document.createElement("li");t.textContent=e,s.appendChild(t)})),a.classList.remove("hidden"),r.classList.add("hidden")}(c),t.classList.add("hidden"),n.classList.remove("hidden")):(O(),t.classList.remove("hidden"),n.classList.add("hidden"))}function O(){a.classList.add("hidden"),r.classList.remove("hidden")}function R(){const t=e.value.trim();if(!t)return;const n=t.split(/\s+/).filter((e=>""!==e.trim())),o=[],a=new Set;n.forEach((e=>{const t=e.replace(/[^a-zA-Z]/g,"");t&&!a.has(t.toLowerCase())&&(o.push(t),a.add(t.toLowerCase()))})),e.value=o.join(" "),h()}async function w(){T=[],p=0,c.textContent="INITIALIZING GENERATION...",i.style.display="none",l.style.display="none",e.disabled=!0,u.classList.add("active"),I.textContent="0%",L.textContent="INITIATING GENERATION PROTOCOL...",g.textContent="";const n=e.value.trim().split(/\s+/).filter((e=>""!==e.trim())).map((e=>e.replace(/[^a-zA-Z]/g,""))).filter((e=>""!==e)),a=Array.from(new Set(n.map((e=>e.toLowerCase())))).map((e=>n.find((t=>t.toLowerCase()===e)))),s=a.length,r=s*(s-1);if(0===r)return L.textContent="NO VALID NAMES FOR COMBINATION.",g.textContent="EXPECTED: 0 COMBINATIONS.",void setTimeout((()=>{x(),c.textContent="GENERATION ABORTED: NO VALID NAMES.",e.disabled=!1}),2e3);let d=y("accessToken"),E=y("wc");if(!d){const e=await fetch(`${C}/get-accessToken`);if(!e.ok)throw new Error("Failed to get access token from server");d=(await e.json()).accessToken,A("accessToken",d)}if(!E){const e=await fetch(`${C}/wc`,{headers:{Authorization:`Bearer ${d}`}});if(!e.ok)throw f("accessToken"),new Error(`Failed to load worker code: ${e.statusText||e.status}`);E=await e.text(),A("wc",E)}const m=new Blob([E],{type:"application/javascript"});N=new Worker(URL.createObjectURL(m)),N.onmessage=async function(n){if(n.data.chunk&&n.data.chunk.length>0){t.disabled=!0,o.disabled=!0,T=T.concat(n.data.chunk),p=T.length;const e=Math.round(100*n.data.progress);b(e),L.textContent=`PROCESSING DATA: ${e}% COMPLETE.`,g.textContent=`EXPECTED: ${r.toLocaleString()} COMBINATIONS. CURRENT: ${p.toLocaleString()}`}n.data.done&&(b(100),L.textContent="GENERATION COMPLETE!",g.textContent=`FINAL COMBINATIONS: ${T.length.toLocaleString()}`,c.textContent="GENERATION COMPLETE!",i.innerHTML=`TOTAL COMBINATIONS: <span style="color:#bf80ff">${T.length.toLocaleString()}</span>`,i.style.display="block",l.style.display="flex",e.disabled=!1,o.disabled=!1,N&&(N.terminate(),N=null),setTimeout(x,2e3))},N.onerror=function(t){console.error("Worker error:",t),L.textContent="ERROR: GENERATION FAILED.",g.textContent="PLEASE REVIEW INPUT AND RETRY.",c.textContent="ERROR: GENERATION FAILED.",e.disabled=!1,N&&(N.terminate(),N=null),setTimeout(x,3e3)},N.postMessage({names:a,chunkSize:1e4,delay:0})}async function v(){if(0===p)return;c.textContent="PREPARING DOWNLOAD...";const e=T.join("\n"),t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t),o=document.createElement("a"),a=new Date;o.href=n,o.download=`${p}-Combination-NAME COMBINE.EXE-${a.toLocaleDateString()}-${a.toLocaleTimeString().replace(/:/g,"-")}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),c.textContent="DOWNLOAD INITIATED.",setTimeout((()=>{c.textContent="GENERATION COMPLETE!"}),2e3)}async function S(){if(0===p)return;c.textContent="ACCESSING RESULTS IN NEW TAB...";const e=T.join("\n"),t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t);window.open(n,"_blank"),setTimeout((()=>{c.textContent="GENERATION COMPLETE!"}),2e3)}function x(){u.classList.remove("active")}function b(e){m.style.background=`conic-gradient(var(--progress-bar-color) 0% ${e}%, var(--border-color) ${e}% 100%)`,I.textContent=`${e}%`}function B(){t.disabled=!1,N=null,T=[],p=0,e.value="",c.textContent="AWAITING COMMAND...",i.style.display="none",l.style.display="none",O(),h()}!async function(){e.value="",e.addEventListener("input",h),t.addEventListener("click",w),o.addEventListener("click",B),n.addEventListener("click",R),d.addEventListener("click",v),E.addEventListener("click",S),h()}()}));