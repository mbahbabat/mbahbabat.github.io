document.addEventListener("DOMContentLoaded",(function(){const t=document.getElementById("input"),e=document.getElementById("line-numbers"),n=document.getElementById("generate"),o=document.getElementById("fix-input"),a=document.getElementById("reset-system"),s=document.getElementById("error-section"),i=document.getElementById("error-list"),c=document.getElementById("output-info"),r=document.getElementById("output-message"),l=document.getElementById("total-combinations-display"),d=document.getElementById("post-generation-controls"),u=document.getElementById("download"),m=document.getElementById("open-in-new-tab"),E=document.getElementById("progress-overlay"),g=document.getElementById("donut-chart"),f=document.getElementById("donut-percentage"),p=document.getElementById("overlay-message"),I=document.getElementById("overlay-sub-message"),y="https://combine-exe.mbahbabat.workers.dev";let T=null,C=[],L=0;const h={set:(t,e)=>{try{const n={data:e,timestamp:Date.now()};return localStorage.setItem(t,JSON.stringify(n)),!0}catch(t){return console.warn("LocalStorage set failed:",t),!1}},get:t=>{try{const e=localStorage.getItem(t);if(!e)return null;const n=JSON.parse(e);return Date.now()-n.timestamp>864e5?(localStorage.removeItem(t),null):n.data}catch(t){return console.warn("LocalStorage get failed:",t),null}},remove:t=>{try{return localStorage.removeItem(t),!0}catch(t){return console.warn("LocalStorage remove failed:",t),!1}}};function x(){const n=t.value.split("\n");let o="";for(let t=1;t<=n.length;t++)o+=String(t).padStart(8,"0")+"\n";e.textContent=o,e.scrollTop=t.scrollTop}function O(){const a=t.value.trim(),r=[];if(!a)return void N();const l=a.split(/\s+/).filter((t=>""!==t.trim())).map((t=>t.replace(/[^a-zA-Z]/g,""))).filter((t=>""!==t)),d=new Set,u=[];l.forEach((t=>{d.has(t.toLowerCase())?r.push(`DUPLICATE NAME DETECTED: ${t}`):(d.add(t.toLowerCase()),u.push(t))}));const m=a.split(/\s+/).filter((t=>""!==t.trim())),E=[];m.forEach((t=>{t.replace(/[^a-zA-Z]/g,"")!==t&&E.push(t)})),E.length>0&&r.push(`INVALID CHARACTERS IN: ${E.join(", ")}`),r.length>0?(!function(n){i.innerHTML="",n.forEach((t=>{const e=document.createElement("li");e.textContent=t,i.appendChild(e)})),s.classList.remove("hidden"),c.classList.add("hidden"),t.style.cssText="background: #330011; color: red; animation: blink-animation 1s infinite;",e.style.cssText="background: #330011; color: red; animation: blink-animation 0.7s infinite;"}(r),n.classList.add("hidden"),o.classList.remove("hidden")):(N(),n.classList.remove("hidden"),o.classList.add("hidden"))}function N(){s.classList.add("hidden"),c.classList.remove("hidden"),t.style.cssText="",e.style.cssText=""}function v(){const e=t.value.trim();if(!e)return;const o=e.split(/\s+/).filter((t=>""!==t.trim())),a=[],s=new Set;o.forEach((t=>{const e=t.replace(/[^a-zA-Z]/g,"");e&&!s.has(e.toLowerCase())&&(a.push(e),s.add(e.toLowerCase()))})),t.value=a.join("\n"),x(),O(),n.style.cssText="background: #00ffff; color:#000; animation: blink-animation 1s infinite;"}async function w(){C=[],L=0,r.textContent="INITIALIZING EXECUTION...",l.style.display="none",d.style.display="none",t.readOnly=!0,n.style.cssText="",t.style.cssText="opacity:0.5; background: #660033; cursor: not-allowed",e.style.cssText="opacity:0.5; background: none; cursor: not-allowed",E.classList.add("active"),f.textContent="0%",p.textContent="INITIATING EXECUTION PROTOCOL...",I.textContent="";const o=t.value.trim().split(/\s+/).filter((t=>""!==t.trim())).map((t=>t.replace(/[^a-zA-Z]/g,""))).filter((t=>""!==t)),s=Array.from(new Set(o.map((t=>t.toLowerCase())))).map((t=>o.find((e=>e.toLowerCase()===t)))),i=s.length,c=i*(i-1);if(0===c)return p.textContent="NO VALID NAMES FOR COMBINATION.",I.textContent="EXPECTED: 0 COMBINATIONS.",setTimeout((()=>{A(),r.textContent="EXECUTION ABORTED: NO VALID NAMES."}),2e3),void B();let u=h.get("accessToken"),m=h.get("wc");if(!u){const t=await fetch(`${y}/get-accessToken`);if(!t.ok)throw new Error("Failed to get access token from server");u=(await t.json()).accessToken,h.set("accessToken",u)}if(!m){const t=await fetch(`${y}/wc`,{headers:{Authorization:`Bearer ${u}`}});if(!t.ok)throw h.remove("accessToken"),new Error(`Failed to load worker code: ${t.statusText||t.status}`);m=await t.text(),h.set("wc",m)}const g=new Blob([m],{type:"application/javascript"});T=new Worker(URL.createObjectURL(g)),T.onmessage=async function(t){if(t.data.chunk&&t.data.chunk.length>0){n.disabled=!0,a.disabled=!0,C=C.concat(t.data.chunk),L=C.length;const e=Math.round(100*t.data.progress);k(e),p.textContent=`PROCESSING DATA: ${e}% COMPLETE.`,I.textContent=`EXPECTED: ${c.toLocaleString()} COMBINATIONS. CURRENT: ${L.toLocaleString()}`}t.data.done&&(k(100),p.textContent="EXECUTION COMPLETE!",I.textContent=`FINAL COMBINATIONS: ${C.length.toLocaleString()}`,r.textContent="EXECUTION COMPLETE!",l.innerHTML=`TOTAL COMBINATIONS: <span style="color:#ffff00; font-weight: 900; text-shadow: 1px 1px 0px black">${C.length.toLocaleString()}</span>`,l.style.cssText="display: block; animation : blink-animation 1s infinite",d.style.display="flex",a.disabled=!1,T&&(T.terminate(),T=null),setTimeout(A,2e3))},T.onerror=function(n){console.error("Worker error:",n),p.textContent="ERROR: EXECUTION FAILED.",I.textContent="PLEASE REVIEW INPUT AND RETRY.",r.textContent="ERROR: EXECUTION FAILED.",t.readOnly=!1,t.style.cssText="",e.style.cssText="",T&&(T.terminate(),T=null),setTimeout(A,3e3)},T.postMessage({names:s,chunkSize:1e5,delay:0})}async function S(){if(0===L)return;r.textContent="PREPARING DOWNLOAD...";const t=C.join("\n"),e=new Blob([t],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(e),o=document.createElement("a"),a=new Date;o.href=n,o.download=`${L}-Combination-NAME COMBINE.EXE-${a.toLocaleDateString()}-${a.toLocaleTimeString().replace(/:/g,"-")}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),r.textContent="DOWNLOAD INITIATED.",setTimeout((()=>{r.textContent="EXECUTION SUCCESSFUL!"}),2e3)}async function b(){if(0===L)return;r.textContent="ACCESSING RESULTS IN NEW TAB...";const t=C.join("\n"),e=new Blob([t],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(e);window.open(n,"_blank"),setTimeout((()=>{r.textContent="EXECUTION SUCCESSFUL!"}),2e3)}function A(){E.classList.remove("active")}function k(t){g.style.background=`conic-gradient(var(--progress-bar-color) 0% ${t}%, var(--border-color) ${t}% 100%)`,f.textContent=`${t}%`}function B(){t.readOnly=!1,t.style.cssText="",e.style.cssText="",n.disabled=!1,T=null,C=[],L=0,t.value="",r.textContent="AWAITING COMMAND...",l.style.display="none",d.style.display="none",N(),O()}!async function(){n.addEventListener("click",w),a.addEventListener("click",B),o.addEventListener("click",v),u.addEventListener("click",S),m.addEventListener("click",b),t.value="",function(){let e;function n(){let e=t.value.trim().split(/\s+/).filter((t=>t));t.value=e.join("\n"),O(),x()}t.addEventListener("click",(function(){n(),O(),x()})),t.addEventListener("scroll",(function(){n(),O(),x()})),t.addEventListener("blur",(function(){n(),O(),x()})),t.addEventListener("input",(function(){clearTimeout(e),O(),e=setTimeout(n,3e3),x()})),t.addEventListener("paste",(function(t){t.preventDefault();const e=(t.clipboardData||window.clipboardData).getData("text").trim().split(/\s+/).filter((t=>t)).join("\n"),n=this.selectionStart,o=this.selectionEnd,a=this.value;this.value=a.substring(0,n)+e+a.substring(o),this.setSelectionRange(n+e.length,n+e.length),O(),x()}))}(),x()}()}));
