document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("input"),t=document.getElementById("generate"),n=document.getElementById("fix-input"),o=document.getElementById("reset-system"),a=document.getElementById("error-section"),s=document.getElementById("error-list"),r=document.getElementById("output-info"),c=document.getElementById("output-message"),i=document.getElementById("total-combinations-display"),l=document.getElementById("post-generation-controls"),d=document.getElementById("download"),u=document.getElementById("open-in-new-tab"),E=document.getElementById("progress-overlay"),m=document.getElementById("donut-chart"),g=document.getElementById("donut-percentage"),p=document.getElementById("overlay-message"),I=document.getElementById("overlay-sub-message"),f="https://combine-exe.mbahbabat.workers.dev";let L=null,T=[],y=0,h="";const C={set:(e,t)=>{try{const n={data:t,timestamp:Date.now()};return localStorage.setItem(e,JSON.stringify(n)),!0}catch(e){return console.warn("LocalStorage set failed:",e),!1}},get:e=>{try{const t=localStorage.getItem(e);if(!t)return null;const n=JSON.parse(t);return Date.now()-n.timestamp>864e5?(localStorage.removeItem(e),null):n.data}catch(e){return console.warn("LocalStorage get failed:",e),null}},remove:e=>{try{return localStorage.removeItem(e),!0}catch(e){return console.warn("LocalStorage remove failed:",e),!1}}};function N(e){return e.split("\n").map((e=>e.replace(/^\d+\s*/,""))).join("\n")}function O(){const t=N(e.value);h=t.split("\n").map(((e,t)=>`${String(t+1).padStart(8,"0")} ${e}`)).join("\n"),e.value=h}function A(){const o=N(h),c=[];if(!o)return v(),void(e.value="");const i=o.split(/\s+/).filter((e=>""!==e.trim())).map((e=>e.replace(/[^a-zA-Z]/g,""))).filter((e=>""!==e)),l=new Set,d=[];i.forEach((e=>{l.has(e.toLowerCase())?c.push(`DUPLICATE NAME DETECTED: ${e}`):(l.add(e.toLowerCase()),d.push(e))}));const u=o.split(/\s+/).filter((e=>""!==e.trim())),E=[];u.forEach((e=>{e.replace(/[^a-zA-Z]/g,"")!==e&&E.push(e)})),E.length>0&&c.push(`INVALID CHARACTERS IN: ${E.join(", ")}`),c.length>0?(!function(e){s.innerHTML="",e.forEach((e=>{const t=document.createElement("li");t.textContent=e,s.appendChild(t)})),a.classList.remove("hidden"),r.classList.add("hidden")}(c),t.classList.add("hidden"),n.classList.remove("hidden")):(v(),t.classList.remove("hidden"),n.classList.add("hidden"))}function v(){a.classList.add("hidden"),r.classList.remove("hidden")}async function w(){T=[],y=0,c.textContent="INITIALIZING GENERATION...",i.style.display="none",l.style.display="none",e.readOnly=!0,e.style.cssText="opacity:0.5; background: #660033; cursor: not-allowed",E.classList.add("active"),g.textContent="0%",p.textContent="INITIATING GENERATION PROTOCOL...",I.textContent="";const n=N(h).split(/\s+/).filter((e=>""!==e.trim())).map((e=>e.replace(/[^a-zA-Z]/g,""))).filter((e=>""!==e)),a=Array.from(new Set(n.map((e=>e.toLowerCase())))).map((e=>n.find((t=>t.toLowerCase()===e)))),s=a.length,r=s*(s-1);if(0===r)return p.textContent="NO VALID NAMES FOR COMBINATION.",I.textContent="EXPECTED: 0 COMBINATIONS.",setTimeout((()=>{S(),c.textContent="GENERATION ABORTED: NO INPUT."}),2e3),void k();let d=C.get("accessToken"),u=C.get("wc");if(!d){const e=await fetch(`${f}/get-accessToken`);if(!e.ok)throw new Error("Failed to get access token from server");d=(await e.json()).accessToken,C.set("accessToken",d)}if(!u){const e=await fetch(`${f}/wc`,{headers:{Authorization:`Bearer ${d}`}});if(!e.ok)throw C.remove("accessToken"),new Error(`Failed to load worker code: ${e.statusText||e.status}`);u=await e.text(),C.set("wc",u)}const m=new Blob([u],{type:"application/javascript"});L=new Worker(URL.createObjectURL(m)),L.onmessage=async function(e){if(e.data.chunk&&e.data.chunk.length>0){t.disabled=!0,o.disabled=!0,T=T.concat(e.data.chunk),y=T.length;const n=Math.round(100*e.data.progress);b(n),p.textContent=`PROCESSING DATA: ${n}% COMPLETE.`,I.textContent=`EXPECTED: ${r.toLocaleString()} COMBINATIONS. CURRENT: ${y.toLocaleString()}`}e.data.done&&(b(100),p.textContent="GENERATION COMPLETE!",I.textContent=`FINAL COMBINATIONS: ${T.length.toLocaleString()}`,c.textContent="GENERATION COMPLETE!",i.innerHTML=`TOTAL COMBINATIONS: <span style="color:#ffff00; font-weight: 900; text-shadow: 1px 1px 0px black">${T.length.toLocaleString()}</span>`,i.style.display="block",l.style.display="flex",o.disabled=!1,L&&(L.terminate(),L=null),setTimeout(S,2e3))},L.onerror=function(t){console.error("Worker error:",t),p.textContent="ERROR: GENERATION FAILED.",I.textContent="PLEASE REVIEW INPUT AND RETRY.",c.textContent="ERROR: GENERATION FAILED.",e.readOnly=!1,e.style.cssText="",L&&(L.terminate(),L=null),setTimeout(S,3e3)},L.postMessage({names:a,chunkSize:1e5,delay:0})}async function x(){if(0===y)return;c.textContent="PREPARING DOWNLOAD...";const e=T.join("\n"),t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t),o=document.createElement("a"),a=new Date;o.href=n,o.download=`${y}-Combination-NAME COMBINE.EXE-${a.toLocaleDateString()}-${a.toLocaleTimeString().replace(/:/g,"-")}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),c.textContent="DOWNLOAD INITIATED.",setTimeout((()=>{c.textContent="GENERATION COMPLETE!"}),2e3)}async function R(){if(0===y)return;c.textContent="ACCESSING RESULTS IN NEW TAB...";const e=T.join("\n"),t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t);window.open(n,"_blank"),setTimeout((()=>{c.textContent="GENERATION COMPLETE!"}),2e3)}function S(){E.classList.remove("active")}function b(e){m.style.background=`conic-gradient(var(--progress-bar-color) 0% ${e}%, var(--border-color) ${e}% 100%)`,g.textContent=`${e}%`}function k(){e.readOnly=!1,e.style.cssText="",t.disabled=!1,L=null,T=[],y=0,c.textContent="AWAITING COMMAND...",i.style.display="none",l.style.display="none",v(),h="",e.value="",setTimeout((()=>{e.value=""}),50)}!async function(){e.addEventListener("click",(function(){O()})),e.addEventListener("scroll",(function(){O()})),n.addEventListener("click",(function(){!function(){const t=N(h);if(!t)return;const n=t.split(/\s+/).filter((e=>""!==e.trim())),o=[],a=new Set;n.forEach((e=>{const t=e.replace(/[^a-zA-Z]/g,"");t&&!a.has(t.toLowerCase())&&(o.push(t),a.add(t.toLowerCase()))})),e.value=o.join("\n"),O(),A()}()})),t.addEventListener("click",w),o.addEventListener("click",k),d.addEventListener("click",x),u.addEventListener("click",R),e.value="",function(){let t;function n(){let t=N(h).split(/\s+/).filter((e=>e));e.value=t.join("\n"),O(),A()}e.addEventListener("blur",n),e.addEventListener("input",(function(){clearTimeout(t),O(),A(),t=setTimeout(n,2e3)})),e.addEventListener("paste",(function(e){e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text").trim().split(/\s+/).filter((e=>e)).join("\n"),n=this.selectionStart,o=this.selectionEnd,a=this.value;this.value=a.substring(0,n)+t+a.substring(o),this.setSelectionRange(n+t.length,n+t.length),O(),A()}))}()}()}));