document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("input"),t=document.getElementById("generate"),n=document.getElementById("fix-input"),o=document.getElementById("reset-system"),a=document.getElementById("error-section"),s=document.getElementById("error-list"),r=document.getElementById("output-info"),c=document.getElementById("output-message"),l=document.getElementById("total-combinations-display"),i=document.getElementById("post-generation-controls"),d=document.getElementById("download"),u=document.getElementById("open-in-new-tab"),E=document.getElementById("progress-overlay"),m=document.getElementById("donut-chart"),I=document.getElementById("donut-percentage"),p=document.getElementById("overlay-message"),g=document.getElementById("overlay-sub-message"),L="https://combine-exe.mbahbabat.workers.dev";let y=null,T=[],C=0;const N={set:(e,t)=>{try{const n={data:t,timestamp:Date.now()};return localStorage.setItem(e,JSON.stringify(n)),!0}catch(e){return console.warn("LocalStorage set failed:",e),!1}},get:e=>{try{const t=localStorage.getItem(e);if(!t)return null;const n=JSON.parse(t);return Date.now()-n.timestamp>864e5?(localStorage.removeItem(e),null):n.data}catch(e){return console.warn("LocalStorage get failed:",e),null}},remove:e=>{try{return localStorage.removeItem(e),!0}catch(e){return console.warn("LocalStorage remove failed:",e),!1}}};function f(){const o=e.value.trim(),c=[];if(!o)return void h();const l=o.split(/\s+/).filter((e=>""!==e.trim())).map((e=>e.replace(/[^a-zA-Z]/g,""))).filter((e=>""!==e)),i=new Set,d=[];l.forEach((e=>{i.has(e.toLowerCase())?c.push(`DUPLICATE NAME DETECTED: ${e}`):(i.add(e.toLowerCase()),d.push(e))}));const u=o.split(/\s+/).filter((e=>""!==e.trim())),E=[];u.forEach((e=>{e.replace(/[^a-zA-Z]/g,"")!==e&&E.push(e)})),E.length>0&&c.push(`INVALID CHARACTERS IN: ${E.join(", ")}`),c.length>0?(!function(e){s.innerHTML="",e.forEach((e=>{const t=document.createElement("li");t.textContent=e,s.appendChild(t)})),a.classList.remove("hidden"),r.classList.add("hidden")}(c),t.classList.add("hidden"),n.classList.remove("hidden")):(h(),t.classList.remove("hidden"),n.classList.add("hidden"))}function h(){a.classList.add("hidden"),r.classList.remove("hidden")}function O(){const t=e.value.trim();if(!t)return;const n=t.split(/\s+/).filter((e=>""!==e.trim())),o=[],a=new Set;n.forEach((e=>{const t=e.replace(/[^a-zA-Z]/g,"");t&&!a.has(t.toLowerCase())&&(o.push(t),a.add(t.toLowerCase()))})),e.value=o.join(" "),f()}async function A(){T=[],C=0,c.textContent="INITIALIZING GENERATION...",l.style.display="none",i.style.display="none",e.readOnly=!0,e.style.cssText="opacity:0.5; background: #660033; cursor: not-allowed",E.classList.add("active"),I.textContent="0%",p.textContent="INITIATING GENERATION PROTOCOL...",g.textContent="";const n=e.value.trim().split(/\s+/).filter((e=>""!==e.trim())).map((e=>e.replace(/[^a-zA-Z]/g,""))).filter((e=>""!==e)),a=Array.from(new Set(n.map((e=>e.toLowerCase())))).map((e=>n.find((t=>t.toLowerCase()===e)))),s=a.length,r=s*(s-1);if(0===r)return p.textContent="NO VALID NAMES FOR COMBINATION.",g.textContent="EXPECTED: 0 COMBINATIONS.",void setTimeout((()=>{v(),c.textContent="GENERATION ABORTED: NO VALID NAMES."}),2e3);let d=N.get("accessToken"),u=N.get("wc");if(!d){const e=await fetch(`${L}/get-accessToken`);if(!e.ok)throw new Error("Failed to get access token from server");d=(await e.json()).accessToken,N.set("accessToken",d)}if(!u){const e=await fetch(`${L}/wc`,{headers:{Authorization:`Bearer ${d}`}});if(!e.ok)throw N.remove("accessToken"),new Error(`Failed to load worker code: ${e.statusText||e.status}`);u=await e.text(),N.set("wc",u)}const m=new Blob([u],{type:"application/javascript"});y=new Worker(URL.createObjectURL(m)),y.onmessage=async function(e){if(e.data.chunk&&e.data.chunk.length>0){t.disabled=!0,o.disabled=!0,T=T.concat(e.data.chunk),C=T.length;const n=Math.round(100*e.data.progress);R(n),p.textContent=`PROCESSING DATA: ${n}% COMPLETE.`,g.textContent=`EXPECTED: ${r.toLocaleString()} COMBINATIONS. CURRENT: ${C.toLocaleString()}`}e.data.done&&(R(100),p.textContent="GENERATION COMPLETE!",g.textContent=`FINAL COMBINATIONS: ${T.length.toLocaleString()}`,c.textContent="GENERATION COMPLETE!",l.innerHTML=`TOTAL COMBINATIONS: <span style="color:#ffff00; font-weight: 900; text-shadow: 1px 1px 0px black">${T.length.toLocaleString()}</span>`,l.style.display="block",i.style.display="flex",o.disabled=!1,y&&(y.terminate(),y=null),setTimeout(v,2e3))},y.onerror=function(t){console.error("Worker error:",t),p.textContent="ERROR: GENERATION FAILED.",g.textContent="PLEASE REVIEW INPUT AND RETRY.",c.textContent="ERROR: GENERATION FAILED.",e.readOnly=!1,e.style.cssText="",y&&(y.terminate(),y=null),setTimeout(v,3e3)},y.postMessage({names:a,chunkSize:1e5,delay:0})}async function x(){if(0===C)return;c.textContent="PREPARING DOWNLOAD...";const e=T.join("\n"),t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t),o=document.createElement("a"),a=new Date;o.href=n,o.download=`${C}-Combination-NAME COMBINE.EXE-${a.toLocaleDateString()}-${a.toLocaleTimeString().replace(/:/g,"-")}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),c.textContent="DOWNLOAD INITIATED.",setTimeout((()=>{c.textContent="GENERATION COMPLETE!"}),2e3)}async function w(){if(0===C)return;c.textContent="ACCESSING RESULTS IN NEW TAB...";const e=T.join("\n"),t=new Blob([e],{type:"text/plain;charset=utf-8"}),n=URL.createObjectURL(t);window.open(n,"_blank"),setTimeout((()=>{c.textContent="GENERATION COMPLETE!"}),2e3)}function v(){E.classList.remove("active")}function R(e){m.style.background=`conic-gradient(var(--progress-bar-color) 0% ${e}%, var(--border-color) ${e}% 100%)`,I.textContent=`${e}%`}function S(){e.readOnly=!1,e.style.cssText="",t.disabled=!1,y=null,T=[],C=0,e.value="",c.textContent="AWAITING COMMAND...",l.style.display="none",i.style.display="none",h(),f()}!async function(){e.addEventListener("input",f),t.addEventListener("click",A),o.addEventListener("click",S),n.addEventListener("click",O),d.addEventListener("click",x),u.addEventListener("click",w),f(),e.value=""}()}));
