import{initializeApp}from"https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";import{getDatabase,ref,onValue,query,orderByChild,startAt,endAt,limitToLast,get,onChildAdded,onChildRemoved}from"https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";const crexs=bstx(h3tx(h3tx(bstx("MzYzNTM3MzkzNDYxMzYzODM2MzMzNDM3MzY2MzM0NjMzNTYxMzUzODM2NjIzNjM5MzQ2NjM2MzkzNDYxMzQzMjM1MzMzNTM4MzczMDM2MzgzNTM1MzMzMzM2NjMzNDMyMzUzMjMzMzEzNjM3MzczNDM1NjEzNTM3MzYzODM0MzczNDY1MzUzODM0MzIzNTM1MzUzOTMzMzMzNzMwMzUzNzM1NjEzNjYxMzUzNjM3MzkzNTMzMzQzNDM1NjEzMzMwMzUzMTM1MzUzNzM4MzQ2NDM1MzYzMzMzMzQzMjM0MzUzNjMxMzQzNjM0MzkzNzYxMzUzMzM2NjQzNjYzMzMzNDM1MzIzNjYyMzUzNTM2MzkzNDYzMzQzMzM0NjEzNjM4MzYzNDM1MzgzNTMyMzY2NjM1MzIzNDM3MzMzOTM3MzQzNTM5MzUzNzM2NjMzNzM1MzQzOTM2NjEzNjY2MzYzOTM2MzQzMzMyMzUzNjM2MzkzNDYzMzUzNzM0MzYzNzM1MzUzOTM1MzczNzM4MzMzNTM2MzQzNDM3MzY2MzM2NjEzNjMzMzczOTMzMzAzMzMyMzQ2NTMzMzIzNTYxMzYzOTM1NjEzNjM5MzMzNTM2NjQzNjMxMzUzODM0NjEzNjYzMzUzOTM2NjQzNDM2Mzc2MTM1NjEzNTM3MzQzNjM3MzczNjMzMzQzMzMzMzUzNjYxMzYzMjMzMzIzMzMwMzYzOTM0NjMzNDMzMzQ2MTM2NjIzNTM5MzUzODM1MzIzNjM4MzUzOTM2NjQzNDM2Mzc2MTM1NjEzNTM2MzUzNjM1MzMzNTM0MzQzMzM0MzkzMzM2MzQzOTM2NjQzNjM4MzMzMDM2MzQzNDM4MzQzMjM3NjEzNDY2MzYzOTMzMzgzNzM2MzYzNDMzMzIzNTM2MzYzOTM0NjMzNTM3MzQzNjM3MzUzNTM5MzUzNzM3MzgzMzM1MzYzNDM0MzczNjYzMzY2MTM2MzMzNzM5MzMzMDMzMzIzNDY1MzMzMjM1NjEzNjM5MzU2MTM2MzkzMzMxMzY2MjM1NjEzNTM3MzU2MTM2MzgzNjM0MzUzNzM3MzgzMzMwMzQ2MzM1MzgzNDYxMzMzMDM1NjEzNDM3MzQzOTM3MzUzNTM5MzUzODM0NjUzNzMwMzUzOTM1MzMzMzMxMzc2MTM2MzIzMzMzMzUzNjMzMzAzNjMxMzQzNzM1MzYzNjM4MzYzMzMzMzMzNTMxMzczODM0NjMzNjY0MzU2MTM3MzAzNjMzMzY2NDM1MzYzNjM5MzUzOTM1MzgzNDY1MzY2MzM1NjEzNDM3MzQzNjMzMzAzNTM5MzUzNzM0NjEzNjM4MzYzMzMzMzIzNTM1MzczNTM1MzkzNTM4MzQzMjM3MzczNDM5MzYzOTM3MzczNjM5MzYzMzM0MzgzNDYxMzczNjM2MzEzNjY0MzUzNjM2NjEzNjM0MzQzNTM2NjMzNjYyMzQzOTM2NjEzNjY2MzYzNzM0MzkzNjY1MzYzNDM2NjMzNTM5MzYzOTMzMzEzNjM4MzYzMjM2NjQzNDM2MzczMzM2MzUzNTM4MzUzMjM3MzAzNTM5MzMzMzM0NjQzNzM0MzQ2NTM2NjEzNjM0MzY2NDM1MzkzNjY0MzUzOTM2MzkzNDYzMzQzMzM0NjEzNzYxMzYzNDM0MzczMzM5MzczOTM1MzkzNTM3MzYzNDM2NjMzNTMxMzY2NTM1MzYzNjYxMzYzMTMzMzIzNTM2MzMzMDM0MzkzNjYxMzY2NjM2MzkzNjM0MzMzMjM1MzYzNjM5MzQ2MzM1MzczNDM2MzczNTM1MzkzNTM3MzczODMzMzUzNjM0MzQzNzM2NjMzNjYxMzYzMzM3MzkzMzMwMzMzMjM0NjUzMzMyMzU2MTM2MzkzNTYxMzYzOTMzMzUzNjY0MzYzMTM1MzgzNDYxMzY2MzM1MzkzNjY0MzQzNjM3NjEzNTYxMzUzODM0NjUzMzMwMzYzMjMzMzMzNDYxMzYzODM1NjEzMzMyMzUzNTM3MzUzNTM5MzUzODM0MzIzNzM3MzQzOTM2MzkzNzM3MzYzOTM2MzIzNTM3MzUzNjM3NjEzNjMzMzMzMjM0MzYzNjY1MzYzMTM1MzczMzM1MzY2NTM1MzUzMzMyMzUzNjM3MzUzNTYxMzQzNzM1MzYzNzM5MzUzMzM1MzczNTMxMzYzOTM0NjYzNjM5MzQzOTMzMzIzNDY0MzQzNDM0NjQzMzM0MzQ2NjM0MzQzNTMxMzMzNDM0NjYzNTM0MzQzMTMzMzUzNDY0MzY2MTM1MzkzNjM5MzQ2MzM0MzMzNDYxMzYzODM2MzMzNDM4MzQzMjM0NjEzNTYxMzQzMzM0MzkzMzM2MzQzOTM2NjEzNDM1MzMzNjM0NjUzNjYxMzQzMTM3NjEzNDY2MzQzNDM2MzczMzMwMzQ2NjM0MzQzNjYyMzczNzM0NjYzNTM0MzQzOTMzMzIzNDY2MzY2NTM2MzQzNjYzMzUzOTM2NjEzNzMwMzY2MjM0NjYzNTM3MzUzOTM3MzkzNDY0MzQzNzM1MzEzMzMwMzUzOTMzMzIzNTMxMzczOTM1NjEzNjYxMzUzOTM3NjEzNDY2MzUzNzM1MzYzNjYzMzUzOTM1MzQzNDYxMzY2MzM0NjYzNDM3MzQ2MTM2NjQzNDM5MzYzOTM3MzczNjM5MzYzMjM1MzczNTM2MzYzODM2MzMzMzMzMzUzNjM3MzkzNTYxMzUzNzMzMzEzNjYzMzYzMjM2NjUzNTMyMzQ2MTM1NjEzNDMzMzQzOTMzMzYzNDM5MzY2MjM2MzMzNzM0MzUzNTM3NjEzNDM2MzQ2NDM0NjYzNTM1MzMzNTM1MzMzNDY0MzY2MzM2NjYzMzMwMzUzNDM1MzMzNDYxMzMzOQ")))),crex=JSON.parse(crexs),app=initializeApp(crex,"analytics dashboard"),database=getDatabase(app);let dailyChart,weeklyChart,monthlyChart,countryChart,currentAppId=null,appsList=[],users=[],stats={daily:{new:0,online:0,returning:0,countries:{}},weekly:{new:0,online:0,returning:0,countries:{}},monthly:{new:0,online:0,returning:0,countries:{}},total:{new:0,online:0,returning:0,countries:{}}},statsListeners=[],usersListener=null,countryListener=null,chartListeners=[],isAppsExpanded=!1,filteredApps=[],visibleUsers=[],startIndex=0,endIndex=0;const itemHeight=60;let visibleItemCount=0;function showLoading(t){const e=document.getElementById(t);e&&(e.style.display="flex")}function hideLoading(t){const e=document.getElementById(t);e&&(e.style.display="none")}async function loadAppsList(){try{showLoading("apps-list-loading");const t=ref(database,"globalWebAnalytics/apps"),e=await get(t);if(e.exists()){const t=e.val();appsList=Object.keys(t).map((t=>({id:t,name:t.split("-").map((t=>t.charAt(0).toUpperCase()+t.slice(1))).join(" "),path:`globalWebAnalytics/apps/${t}`}))),renderAppsList(),appsList.length>0&&!currentAppId&&(currentAppId=appsList[0].id,loadAppData(currentAppId))}else console.error("Tidak ada data aplikasi ditemukan"),document.getElementById("apps-list").innerHTML='<div class="text-center p-3 text-white">Tidak ada aplikasi ditemukan</div>'}catch(t){console.error("Error memuat daftar aplikasi:",t),document.getElementById("apps-list").innerHTML='<div class="text-center p-3 text-white">Gagal memuat daftar aplikasi</div>'}finally{hideLoading("apps-list-loading")}}function renderAppsList(){const t=document.getElementById("apps-list");t.innerHTML="";const e=filteredApps.length>0?filteredApps:appsList;0!==e.length?(e.forEach((e=>{const n=document.createElement("li");n.className="list-group-item app-item "+(e.id===currentAppId?"active":""),n.innerHTML=`\n\t\t\t\t\t\t\t<i class="fa-solid fa-database"></i>\n\t\t\t\t\t\t\t<span>${e.name}</span>\n\t\t\t\t\t\t`,n.dataset.appId=e.id,n.addEventListener("click",(()=>{currentAppId=e.id,document.querySelectorAll(".app-item").forEach((t=>t.classList.remove("active"))),n.classList.add("active"),loadAppData(e.id),document.getElementById("app-search").value="",filteredApps=[],updateToggleButton()})),t.appendChild(n)})),updateToggleButton()):t.innerHTML='<div class="text-center p-3 text-white">Tidak ada aplikasi ditemukan</div>'}function updateToggleButton(){const t=document.getElementById("toggle-apps"),e=document.getElementById("apps-container"),n=filteredApps.length>0?filteredApps:appsList;n.length<=3?(t.style.display="none",e.classList.remove("collapsed")):(t.style.display="block",isAppsExpanded?(e.classList.remove("collapsed"),t.innerHTML='<i class="fas fa-chevron-up me-1"></i> Sembunyikan'):(e.classList.add("collapsed"),t.innerHTML='<i class="fas fa-chevron-down me-1"></i> Lihat Semua ('+(n.length-3)+")"))}function filterApps(t){filteredApps=t?appsList.filter((e=>e.name.toLowerCase().includes(t.toLowerCase()))):[],renderAppsList()}async function loadAppData(t){try{const e=appsList.find((e=>e.id===t))?.name;document.getElementById("app-title").innerHTML=`<i class="fa-solid fa-chart-line"></i> Laporan untuk <span style="color: #009999; font-weight: 900"> ${e}</span>`||"Realtime Analytics",showLoading("total-users-loading"),showLoading("users-list-loading"),showLoading("country-list-loading"),showLoading("daily-stats-loading"),showLoading("weekly-stats-loading"),showLoading("monthly-stats-loading"),showLoading("daily-chart-loading"),showLoading("weekly-chart-loading"),showLoading("monthly-chart-loading"),showLoading("country-chart-loading"),await loadStats(t),await loadUsers(t),await loadChartData(t),await loadCountryData(t)}catch(t){console.error("Error memuat data aplikasi:",t)}}function loadStats(t){const e=`globalWebAnalytics/apps/${t}`,n=new Date,a=formatDate(n),s=formatWeek(n),o=formatMonth(n);statsListeners.length>0&&(statsListeners.forEach((t=>t())),statsListeners=[]);const i={new:`${e}/stats/newUsers/daily/${a}/total`,online:`${e}/stats/onlineUsers/daily/${a}/total`,returning:`${e}/stats/returningUsers/daily/${a}/total`},r={new:`${e}/stats/newUsers/weekly/${s}/total`,online:`${e}/stats/onlineUsers/weekly/${s}/total`,returning:`${e}/stats/returningUsers/weekly/${s}/total`},M={new:`${e}/stats/newUsers/monthly/${o}/total`,online:`${e}/stats/onlineUsers/monthly/${o}/total`,returning:`${e}/stats/returningUsers/monthly/${o}/total`},l={new:`${e}/stats/newUsers/total/total`,online:`${e}/stats/onlineUsers/total/total`,returning:`${e}/stats/returningUsers/total/total`},z=(t,e,n)=>{const a=ref(database,t),s=onValue(a,(t=>{const a=t.exists()&&t.val().count||0;stats[n][e]=a,renderStats(),"daily"===n&&hideLoading("daily-stats-loading"),"weekly"===n&&hideLoading("weekly-stats-loading"),"monthly"===n&&hideLoading("monthly-stats-loading")}),(e=>{console.error(`Error listening to ${t}:`,e)}));statsListeners.push(s)};Object.keys(i).forEach((t=>{z(i[t],t,"daily")})),Object.keys(r).forEach((t=>{z(r[t],t,"weekly")})),Object.keys(M).forEach((t=>{z(M[t],t,"monthly")})),Object.keys(l).forEach((t=>{z(l[t],t,"total")}))}function loadUsers(t){const e=ref(database,`globalWebAnalytics/apps/${t}/users`);usersListener&&usersListener(),usersListener=onValue(e,(t=>{t.exists()?(users=[],t.forEach((t=>{const e=t.val().UserPresence||{},n=e.countryCode,a=e.countryName,s=e.LastIP;users.push({id:t.key,status:e.status||"offline",lastSeen:e.userLastSeen||0,countryCode:n||a||"not set",countryName:a||n||"not set",ip:s})})),users.sort(((t,e)=>"online"===t.status&&"online"!==e.status?-1:"online"!==t.status&&"online"===e.status?1:e.lastSeen-t.lastSeen)),renderUsers(),renderTotal(),hideLoading("users-list-loading"),hideLoading("total-users-loading")):(users=[],renderUsers(),renderTotal(),hideLoading("users-list-loading"),hideLoading("total-users-loading"))}),(t=>{console.error("Error memuat daftar pengguna:",t),hideLoading("users-list-loading"),hideLoading("total-users-loading")}))}function loadCountryData(t){const e=ref(database,`globalWebAnalytics/apps/${t}/stats/countries/total`);countryListener&&countryListener(),countryListener=onValue(e,(t=>{const e=document.getElementById("country-list");if(t.exists()){const n=t.val(),a=[];for(const[t,e]of Object.entries(n))"undefined"!==t&&a.push({countryCode:t,count:e.count||0,countryName:e.countryName||t});a.sort(((t,e)=>e.count-t.count));let s="";a.slice(0,1e3).forEach((t=>{s+=`\n\t\t\t\t\t\t\t\t\t<div class="d-flex justify-content-between align-items-center mb-2">\n\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t<img src="https://flagcdn.com/w20/${t.countryCode.toLowerCase()}.png" class="country-flag" alt="${t.countryCode}">\n\t\t\t\t\t\t\t\t\t\t\t<span> ${t.countryName}</span>\n\t\t\t\t\t\t\t\t\t\t\t<span><strong> (${t.countryCode})</strong></span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<span class="badge bg-primary">${formatNumber(t.count)}</span>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t`})),e.innerHTML=s;const o=a.slice(0,5);document.getElementById("countries-title").innerHTML=`<i class="fa-solid fa-earth-europe"></i> Daftar Negara (${a.length})`,updateCountryChart(o),hideLoading("country-list-loading"),hideLoading("country-chart-loading")}else e.innerHTML='<p class="text-center">No country data available</p>',countryChart&&(countryChart.destroy(),countryChart=null),hideLoading("country-list-loading"),hideLoading("country-chart-loading")}),(t=>{console.error("Error loading country data:",t),document.getElementById("country-list").innerHTML='<p class="text-center text-danger">Error loading data</p>',hideLoading("country-list-loading"),hideLoading("country-chart-loading")}))}function loadChartData(t){const e=`globalWebAnalytics/apps/${t}`;chartListeners.length>0&&(chartListeners.forEach((t=>t())),chartListeners=[]);const n=new Date,a=[];for(let t=6;t>=0;t--){const e=new Date(n);e.setDate(e.getDate()-t),a.push(formatDate(e))}const s=[];for(let t=3;t>=0;t--){const e=new Date(n);e.setDate(e.getDate()-7*t),s.push(formatWeek(e))}const o=[];for(let t=5;t>=0;t--){const e=new Date(n);e.setMonth(e.getMonth()-t),o.push(formatMonth(e))}window.chartData||(window.chartData={daily:{new:[],online:[],returning:[]},weekly:{new:[],online:[],returning:[]},monthly:{new:[],online:[],returning:[]}}),window.chartData.daily={new:[],online:[],returning:[]},window.chartData.weekly={new:[],online:[],returning:[]},window.chartData.monthly={new:[],online:[],returning:[]};const i=["new","online","returning"];[{period:"daily",dates:a,labelFunc:formatDailyLabel},{period:"weekly",dates:s,labelFunc:formatWeeklyLabel},{period:"monthly",dates:o,labelFunc:formatMonthlyLabel}].forEach((({period:t,dates:n,labelFunc:a})=>{i.forEach((a=>{window.chartData[t][a]=new Array(n.length).fill(0),n.forEach(((s,o)=>{((t,n,a,s)=>{const o=`${e}/stats/${a}Users/${t}/${n[s]}/total`,i=ref(database,o),r=onValue(i,(e=>{const n=e.exists()&&e.val().count||0;updateChartData(t,a,s,n),renderChart(t)}),(t=>{console.error(`Error listening to ${o}:`,t)}));chartListeners.push(r)})(t,n,a,o)}))})),setTimeout((()=>{renderChart(t),"daily"===t&&hideLoading("daily-chart-loading"),"weekly"===t&&hideLoading("weekly-chart-loading"),"monthly"===t&&hideLoading("monthly-chart-loading")}),100)}))}function updateChartData(t,e,n,a){window.chartData&&window.chartData[t]&&window.chartData[t][e]&&(window.chartData[t][e][n]=a)}function renderChart(t){const e=formatChartLabels(t,getDatesForPeriod(t)),n=window.chartData[t];switch(t){case"daily":updateDailyChart(e,n);break;case"weekly":updateWeeklyChart(e,n);break;case"monthly":updateMonthlyChart(e,n)}}function getDatesForPeriod(t){const e=new Date;switch(t){case"daily":const t=[];for(let n=6;n>=0;n--){const a=new Date(e);a.setDate(a.getDate()-n),t.push(formatDate(a))}return t;case"weekly":const n=[];for(let t=3;t>=0;t--){const a=new Date(e);a.setDate(a.getDate()-7*t),n.push(formatWeek(a))}return n;case"monthly":const a=[];for(let t=5;t>=0;t--){const n=new Date(e);n.setMonth(n.getMonth()-t),a.push(formatMonth(n))}return a;default:return[]}}function formatChartLabels(t,e){switch(t){case"daily":return e.map((t=>{t.substring(0,4);const e=t.substring(4,6);return`${t.substring(6,8)}/${e}`}));case"weekly":return e.map((t=>`Minggu ${t.split("W")[1]}`));case"monthly":return e.map((t=>{const e=t.substring(0,4),n=t.substring(4,6);return`${["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Ags","Sep","Okt","Nov","Des"][parseInt(n)-1]} ${e}`}));default:return e}}function formatDailyLabel(t){t.substring(0,4);const e=t.substring(4,6);return`${t.substring(6,8)}/${e}`}function formatWeeklyLabel(t){return`Minggu ${t.split("W")[1]}`}function formatMonthlyLabel(t){const e=t.substring(0,4),n=t.substring(4,6);return`${["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Ags","Sep","Okt","Nov","Des"][parseInt(n)-1]} ${e}`}function updateDailyChart(t,e){const n=document.getElementById("dailyChart").getContext("2d");dailyChart&&dailyChart.destroy(),dailyChart=new Chart(n,{type:"line",data:{labels:t,datasets:[{label:"Pengguna Baru",data:e.new,borderColor:"#4cc9f0",backgroundColor:"rgba(76, 201, 240, 0.1)",tension:.3,fill:!0},{label:"Pengguna Online",data:e.online,borderColor:"#3a0ca3",backgroundColor:"rgba(58, 12, 163, 0.1)",tension:.3,fill:!0},{label:"Pengguna Kembali",data:e.returning,borderColor:"#f72585",backgroundColor:"rgba(247, 37, 133, 0.1)",tension:.3,fill:!0}]},options:{maintainAspectRatio:!1,plugins:{title:{display:!0,text:"Statistik Harian (7 Hari Terakhir)"},legend:{position:"top"}}}})}function updateWeeklyChart(t,e){const n=document.getElementById("weeklyChart").getContext("2d");weeklyChart&&weeklyChart.destroy(),weeklyChart=new Chart(n,{type:"line",data:{labels:t,datasets:[{label:"Pengguna Baru",data:e.new,borderColor:"#4cc9f0",backgroundColor:"rgba(76, 201, 240, 0.1)",tension:.3,fill:!0},{label:"Pengguna Online",data:e.online,borderColor:"#3a0ca3",backgroundColor:"rgba(58, 12, 163, 0.1)",tension:.3,fill:!0},{label:"Pengguna Kembali",data:e.returning,borderColor:"#f72585",backgroundColor:"rgba(247, 37, 133, 0.1)",tension:.3,fill:!0}]},options:{maintainAspectRatio:!1,plugins:{title:{display:!0,text:"Statistik Mingguan (4 Minggu Terakhir)"},legend:{position:"top"}}}})}function updateMonthlyChart(t,e){const n=document.getElementById("monthlyChart").getContext("2d");monthlyChart&&monthlyChart.destroy(),monthlyChart=new Chart(n,{type:"line",data:{labels:t,datasets:[{label:"Pengguna Baru",data:e.new,borderColor:"#4cc9f0",backgroundColor:"rgba(76, 201, 240, 0.1)",tension:.3,fill:!0},{label:"Pengguna Online",data:e.online,borderColor:"#3a0ca3",backgroundColor:"rgba(58, 12, 163, 0.1)",tension:.3,fill:!0},{label:"Pengguna Kembali",data:e.returning,borderColor:"#f72585",backgroundColor:"rgba(247, 37, 133, 0.1)",tension:.3,fill:!0}]},options:{maintainAspectRatio:!1,plugins:{title:{display:!0,text:"Statistik Bulanan (6 Bulan Terakhir)"},legend:{position:"top"}}}})}function updateCountryChart(t){const e=document.getElementById("countryChart").getContext("2d");countryChart&&countryChart.destroy();const n=t.map((t=>t.countryName)),a=t.map((t=>t.count));countryChart=new Chart(e,{type:"doughnut",data:{labels:n,datasets:[{data:a,backgroundColor:["#4361ee","#4cc9f0","#3a0ca3","#f72585","#7209b7","#4895ef","#560bad","#b5179e","#f15bb5","#00bbf9"]}]},options:{maintainAspectRatio:!1,plugins:{title:{display:!0,text:"Top 5 Negara Pengguna"},legend:{position:"top"}}}})}function renderStats(){document.getElementById("daily-new").textContent=stats.daily.new,document.getElementById("daily-online").textContent=stats.daily.online,document.getElementById("daily-returning").textContent=stats.daily.returning,document.getElementById("weekly-new").textContent=stats.weekly.new,document.getElementById("weekly-online").textContent=stats.weekly.online,document.getElementById("weekly-returning").textContent=stats.weekly.returning,document.getElementById("monthly-new").textContent=stats.monthly.new,document.getElementById("monthly-online").textContent=stats.monthly.online,document.getElementById("monthly-returning").textContent=stats.monthly.returning}function renderTotal(){const t=document.getElementById("total-user-count"),e=document.getElementById("users-title");t.textContent=`${users.length}`,e.innerHTML=`<i class="fa-solid fa-users"></i> Daftar Pengguna (${users.length})`}function renderUsers(){const t=document.getElementById("show-offline"),e=document.getElementById("show-offline-label"),n=t.checked;if(visibleUsers=n?users:users.filter((t=>"offline"!==t.status)),e.innerHTML=n?'<i class="bi bi-eye"></i> Tampilkan Online Saja':'<i class="bi bi-eye"></i> Tampilkan Semua',0!==visibleUsers.length)window.virtualScrollInitialized||(calculateVisibleItems(),setupVirtualScroll(),window.virtualScrollInitialized=!0),updateVirtualList();else{const t=document.getElementById("users-list-virtual");t&&(t.innerHTML='<div class="text-center p-3 text-muted">Tidak ada pengguna online</div>')}}function calculateVisibleItems(){const t=document.getElementById("users-list");if(!t)return 10;const e=t.clientHeight;return visibleItemCount=Math.ceil(e/itemHeight)+2,visibleItemCount}function updateVirtualList(){const t=document.getElementById("users-list-virtual"),e=document.getElementById("users-list");if(!t||!e)return;const n=e.scrollTop;startIndex=Math.max(0,Math.floor(n/itemHeight)-1),endIndex=Math.min(visibleUsers.length,startIndex+visibleItemCount+2),t.style.height=visibleUsers.length*itemHeight+"px",renderVisibleItems(startIndex,endIndex)}function renderVisibleItems(t,e){const n=document.getElementById("users-list-virtual");if(n){n.innerHTML="";for(let a=t;a<e&&!(a>=visibleUsers.length);a++){const t=createUserItem(visibleUsers[a],a);n.appendChild(t)}}}function createUserItem(t,e){const n=document.createElement("div");n.className="user-item",n.dataset.userId=t.id;const a=`${formatLastSeen(t.lastSeen)}`;return n.innerHTML=`\n\t\t\t\t<div class="d-flex position-relative" style="height:100%">\n\t\t\t\t\t<div class="user-item-overlay" style="background-image: url('https://flagcdn.com/w80/${t.countryCode.toLowerCase()}.png');"></div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="d-flex flex-column flex-grow-1" style="gap:5px; position: relative; z-index: 1;">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<span class="user-uid"> UID: ${t.id}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div style="font-size:0.7rem">\n\t\t\t\t\t\t\t<img src="https://flagcdn.com/w20/${t.countryCode.toLowerCase()}.png" \n\t\t\t\t\t\t\t\t class="mini-country-flag me-2" \n\t\t\t\t\t\t\t\t alt="${t.countryCode}" \n\t\t\t\t\t\t\t\t onerror="this.style.display='none'">\n\t\t\t\t\t\t\t<span class="user-list-country-name"><em>${t.countryName}</em></span>\n\t\t\t\t\t\t\t<span class="user-list-country-code"><strong><em>(${t.countryCode})</em></strong></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="d-flex flex-column align-items-end" style="width: 100px; gap:5px; position: relative; z-index: 1;">\n\t\t\t\t\t\t<span class="badge bg-${getStatusColor(t.status)}" style="width:50px">${t.status}</span>\n\t\t\t\t\t\t<span class="last-seen" style="font-size:0.7rem"><em>${a}</em></span>\t\t\t\t\t\t\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`,n.addEventListener("click",(()=>showUserDetails(t.id))),n}function setupVirtualScroll(){const t=document.getElementById("users-list");if(!t)return;let e;t.addEventListener("scroll",(()=>{clearTimeout(e),e=setTimeout((()=>{updateVirtualList()}),100)})),window.addEventListener("resize",(()=>{calculateVisibleItems(),updateVirtualList()}))}async function showUserDetails(t){const e=ref(database,`globalWebAnalytics/apps/${currentAppId}/users/${t}`);try{const n=await get(e);if(n.exists()){const e=n.val(),a=e.UserPresence||{},s=e.IPHistory||{},o=e.FirebaseUIDHistory||{};showUserModal({id:t,status:a.status||"unknown",lastSeen:formatLastSeen(a.userLastSeen||0),countryCode:a.countryCode||a.countryName,countryName:a.countryName||a.countryCode,lastIP:a.LastIP||"unknown",lastFirebaseUID:a.LastFirebaseUID||"unknown",ipHistory:Object.keys(s).map((t=>({ip:t,countryCode:s[t].countryCode||"unknown",timestamp:formatTimestamp(s[t].timestamp||0)}))),uidHistory:Object.keys(o).map((t=>({uid:t,timestamp:formatTimestamp(o[t].timestamp||0)})))})}}catch(t){console.error("Error memuat detail pengguna:",t)}}function showUserModal(t){const e=document.getElementById("userModal");e&&e.remove();const n=`\n\t\t\t\t\t\t<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">\n\t\t\t\t\t\t\t<div class="modal-dialog modal-lg">\n\t\t\t\t\t\t\t\t<div class="modal-content">\n\t\t\t\t\t\t\t\t\t<div class="modal-header">\n\t\t\t\t\t\t\t\t\t\t<h5 class="modal-title" id="userModalLabel">Detail Pengguna UID: ${t.id}</h5>\n\t\t\t\t\t\t\t\t\t\t<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="modal-body">\n\t\t\t\t\t\t\t\t\t\t<div class="row mb-3">\n\t\t\t\t\t\t\t\t\t\t\t<div class="col-md-6">\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>Status:</strong> \n\t\t\t\t\t\t\t\t\t\t\t\t<span class="badge bg-${getStatusColor(t.status)}">${t.status}</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="col-md-6">\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>Terakhir Dilihat:</strong> ${t.lastSeen}\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div class="row mb-3">\n\t\t\t\t\t\t\t\t\t\t\t<div class="col-md-6">\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>Negara:</strong> \n\t\t\t\t\t\t\t\t\t\t\t\t<img src="https://flagcdn.com/w20/${t.countryCode.toLowerCase()}.png" \n\t\t\t\t\t\t\t\t\t\t\t\t\t class="country-flag ms-1" alt="${t.countryCode}" \n\t\t\t\t\t\t\t\t\t\t\t\t\t onerror="this.style.display='none'">\n\t\t\t\t\t\t\t\t\t\t\t\t${t.countryName} <strong>(${t.countryCode})</strong>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="col-md-6">\n\t\t\t\t\t\t\t\t\t\t\t\t<strong>IP Terakhir:</strong> ${t.lastIP}\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t<div class="mb-3">\n\t\t\t\t\t\t\t\t\t\t\t<h6>Riwayat IP</h6>\n\t\t\t\t\t\t\t\t\t\t\t<div class="table-responsive">\n\t\t\t\t\t\t\t\t\t\t\t\t<table class="table table-sm">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<th>IP</th>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<th>Negara</th>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<th>Waktu</th>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t${t.ipHistory.map((e=>`\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td>${e.ip}</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<img src="https://flagcdn.com/w20/${e.countryCode.toLowerCase()}.png" \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t class="country-flag me-1" alt="${e.countryCode}" \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t onerror="this.style.display='none'">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t${t.countryName} <strong>(${t.countryCode})</strong>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td>${e.timestamp}</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t`)).join("")}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t<div class="mb-3">\n\t\t\t\t\t\t\t\t\t\t\t<h6>Riwayat Firebase UID</h6>\n\t\t\t\t\t\t\t\t\t\t\t<div class="table-responsive">\n\t\t\t\t\t\t\t\t\t\t\t\t<table class="table table-sm">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<th>UID</th>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<th>Waktu</th>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t${t.uidHistory.map((t=>`\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td><code>${t.uid}</code></td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<td>${t.timestamp}</td>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t`)).join("")}\n\t\t\t\t\t\t\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="modal-footer">\n\t\t\t\t\t\t\t\t\t\t<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`;document.body.insertAdjacentHTML("beforeend",n),new bootstrap.Modal(document.getElementById("userModal")).show(),document.getElementById("userModal").addEventListener("hidden.bs.modal",(function(){this.remove()}))}function formatDate(t){return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}${String(t.getDate()).padStart(2,"0")}`}function formatWeek(t){const e=new Date(t.getFullYear(),0,1),n=(t-e)/864e5,a=Math.ceil((n+e.getDay()+1)/7);return`${t.getFullYear()}W${String(a).padStart(2,"0")}`}function formatMonth(t){return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}function formatNumber(t){return t>=1e6?(t/1e6).toFixed(1)+"M":t>=1e3?(t/1e3).toFixed(1)+"K":t}function formatLastSeen(t){if(!t)return"Tidak diketahui";const e=Date.now()-t,n=Math.floor(e/6e4),a=Math.floor(e/36e5),s=Math.floor(e/864e5);return n<1?"Baru saja":n<60?`${n} menit lalu`:a<24?`${a} jam lalu`:`${s} hari lalu`}function formatTimestamp(t){return t?new Date(t).toLocaleString("id-ID"):"Tidak diketahui"}function getStatusColor(t){switch(t){case"online":return"success";case"idle":return"warning";default:return"secondary"}}window.addEventListener("resize",(function(){window.innerWidth>=1024?(isAppsExpanded=!0,updateToggleButton()):(isAppsExpanded=!1,updateToggleButton())})),document.getElementById("app-search").addEventListener("input",(function(t){filterApps(t.target.value)})),document.getElementById("toggle-apps").addEventListener("click",(function(){isAppsExpanded=!isAppsExpanded,updateToggleButton()})),document.getElementById("show-offline").addEventListener("change",renderUsers),document.addEventListener("DOMContentLoaded",(()=>{loadAppsList(),isAppsExpanded=!(window.innerWidth<1024)}));