<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 250px;
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --light-bg: #f8f9fa;
            --dark-bg: #212529;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            overflow-x: hidden;
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h3 {
            font-weight: 600;
            margin: 0;
            font-size: 1.2rem;
        }

        .app-item {
            border: none;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.2s;
            cursor: pointer;
        }

        .app-item:hover,
        .app-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            min-height: 100vh;
        }

        .dashboard-header {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-period {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0.5rem 0;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .chart-panel {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-container {
            position: relative;
			width: 100%;
            height: 18.75rem;
        }

        .users-panel {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .user-card,
        .total-user,
        .country-card {
            background: white;
            height: 500px;
            width: 100%;
            overflow: hidden;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .user-card h5,
        .total-user h5,
        .country-card h5 {
            border-bottom: 1px solid #009999;
            padding-bottom: 15px;
        }

        #total-user-count {
            height: 400px;
            width: 100%;
            font-size: 5rem;
            font-weight: 900;
            color: #0099ff;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #users-list, #country-list {
            height: 350px;
            overflow-y: auto;
        }

		#users-list-virtual{
			display: flex;
			flex-direction: column;
			gap: 10px;
		}
		
        .user-item {
            cursor: pointer;
            transition: background-color 0.2s;
			box-shadow: 1px 1px 2px 1px rgba(0,0,0,0.3);
			padding: 5px;
			border-radius: 5px;
        }

        .user-item:hover {
            background-color: #f8f9fa;
        }

        .country-flag {
            width: 20px;
            height: 20px;
            border-radius: 50%;
			box-shadow: 1px 1px 2px 1px rgba(0,0,0,0.3);
			margin-right: 5px;
        }
		
        .mini-country-flag {
            width: 15px;
            height: 10px;
            border-radius: 3px;
			box-shadow: 0 2px 1px rgba(0,0,0,0.3);
        }		

        .last-seen {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .toggle-offline {
            display: flex;
            justify-content: right;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 10px;
        }

        #daily-new,
        #weekly-new,
        #monthly-new {
            color: #4cc9f0;
        }

        #daily-online,
        #weekly-online,
        #monthly-online {
            color: #3a0ca3;
        }

        #daily-returning,
        #weekly-returning,
        #monthly-returning {
            color: #f72585;
        }

        h5 i {
            color: #009999;
        }

        /* Loading Styles */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 1);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 0.5rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #009999;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @media (max-width: 1023px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .chart-container {
                height: 15.625rem;
            }

            .total-user {
                height: 200px
            }

            #total-user-count {
                height: 100px
            }
        }
		
/* Styles untuk Search dan Toggle */
.search-container {
    display: block;
}

.apps-container {
    max-height: 300px;
    overflow-y: auto;
}

.apps-container.collapsed {
    max-height: 150px; /* Hanya cukup untuk 3 item */
    overflow-y: hidden;
}

.apps-container::-webkit-scrollbar {
    width: 6px;
}

.apps-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

.apps-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

.apps-container::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* Sembunyikan search di desktop jika ingin, atau biarkan selalu tampil */
@media (min-width: 1024px) {
    .search-container {
        display: block; /* atau none jika ingin sembunyikan di desktop */
    }
    
    .apps-container {
        max-height: none !important;
        overflow-y: visible !important;
    }
    
    #toggle-apps {
        display: none !important;
    }
}

@media (max-width: 1023px) {
    .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        padding-bottom: 1rem;
    }
    
    .apps-container.collapsed .app-item:nth-child(n+4) {
        display: none;
    }
    
    .main-content {
        margin-left: 0;
    }
}	

.user-item {
  position: relative;
}

.user-item-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 0.1; 
  z-index: 0;
  pointer-events: none; 
}
    </style>
</head>
<body>
	<!-- Sidebar -->
	<div class="sidebar">
		<div class="sidebar-header">
			<h3>Realtime Analytics</h3>
		</div>
		<div class="sidebar-content p-3">
			<!-- Input Pencarian -->
			<div class="search-container mb-3">
				<div class="input-group input-group-sm">
					<span class="input-group-text bg-light border-0">
						<i class="fas fa-search text-muted"></i>
					</span>
					<input type="text" class="form-control border-0 bg-light" id="app-search" placeholder="Cari project...">
				</div>
			</div>
			
			<h6 class="text-uppercase text-white-50 small mb-3">Pilih Project</h6>
			
			<!-- Container untuk Apps List dengan Scroll -->
			<div class="apps-container" id="apps-container">
				<ul class="list-group list-group-flush" id="apps-list">
					<!-- Loading state for apps list -->
					<div class="loading-container">
						<div class="loading-spinner"></div>
						<div class="loading-text text-white">Memuat daftar aplikasi...</div>
					</div>
				</ul>
			</div>
			
			<!-- Tombol Toggle untuk Mobile -->
			<div class="d-lg-none mt-3">
				<button class="btn btn-outline-light btn-sm w-100" id="toggle-apps">
					<i class="fas fa-chevron-down me-1"></i> Lihat Semua
				</button>
			</div>
		</div>
	</div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="d-flex justify-content-center align-items-center">
                <h2 id="app-title">Realtime Analytics</h2>
            </div>
        </div>
        
        <!-- User Section -->
        <div class="row">
            <div class="col-lg-4">
                <div class="total-user">
                    <h5 class="mb-3"><i class="fa-solid fa-users-viewfinder"></i> Jumlah Pengguna</h5>
                    <div class="position-relative">
                        <p class="d-flex justify-content-center align-items-center" id="total-user-count">0</p>
                        <!-- Loading state for total users -->
                        <div class="loading-overlay" id="total-users-loading">
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Memuat jumlah pengguna...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Daftar Pengguna -->
            <div class="col-lg-4">
                <div class="user-card">
                    <div class="user-card-header d-flex flex-column">
                        <h5 class="mb-3"><i class="fa-solid fa-users"></i> Daftar Pengguna</h5>
                        <div class="toggle-offline">
                            <input type="checkbox" class="btn-check" id="show-offline" autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" id="show-offline-label" for="show-offline">Loading...</label>
                        </div>
                    </div>
                    <div class="position-relative" style="height: 100%;">
                        <div class="list-group" id="users-list" style="height: 350px; overflow-y: auto; position: relative;">
                            <!-- Loading state for users list -->
							<div id="users-list-virtual" style="position: relative;"></div>
							<div class="loading-overlay" id="users-list-loading">
								<div class="loading-container" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
									<div class="loading-spinner"></div>
									<div class="loading-text">Memuat daftar pengguna...</div>
								</div>
							</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Daftar Negara -->
            <div class="col-lg-4">
                <div class="country-card">
                    <h5 class="mb-3"><i class="fa-solid fa-earth-europe"></i> Daftar Negara</h5>
                    <div class="position-relative" style="height: 100%;">
                        <div class="list-group" id="country-list">
                            <!-- Loading state for country list -->
                            <div class="loading-container" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Memuat daftar negara...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistik Cards -->
        <div class="row">
            <!-- Harian -->
            <div class="col-md-6 col-lg-4">
                <div class="stat-card position-relative">
                    <!-- Loading state for daily stats -->
                    <div class="loading-overlay" id="daily-stats-loading">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Memuat statistik harian...</div>
                        </div>
                    </div>
                    <div class="stat-period"><i class="fa-solid fa-calendar"></i> Hari ini</div>
                    <div class="row text-center">
                        <div class="col-4 mt-3">
                            <div class="stat-value" id="daily-new">0</div>
                            <div class="stat-label">Pengguna baru</div>
                        </div>
                        <div class="col-4 mt-3">
                            <div class="stat-value" id="daily-online">0</div>
                            <div class="stat-label">Pengguna Online</div>
                        </div>
                        <div class="col-4 mt-3">
                            <div class="stat-value" id="daily-returning">0</div>
                            <div class="stat-label">Pengguna Kembali</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mingguan -->
            <div class="col-md-6 col-lg-4">
                <div class="stat-card position-relative">
                    <!-- Loading state for weekly stats -->
                    <div class="loading-overlay" id="weekly-stats-loading">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Memuat statistik mingguan...</div>
                        </div>
                    </div>
                    <div class="stat-period"><i class="fa-solid fa-calendar"></i> Minggu ini</div>
                    <div class="row text-center">
                        <div class="col-4 mt-3">
                            <div class="stat-value" id="weekly-new">0</div>
                            <div class="stat-label">Pengguna baru</div>
                        </div>
                        <div class="col-4 mt-3">
                            <div class="stat-value" id="weekly-online">0</div>
                            <div class="stat-label">Pengguna Online</div>
                        </div>
                        <div class="col-4 mt-3">
                            <div class="stat-value" id="weekly-returning">0</div>
                            <div class="stat-label">Pengguna Kembali</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bulanan -->
            <div class="col-md-6 col-lg-4">
                <div class="stat-card position-relative">
                    <!-- Loading state for monthly stats -->
                    <div class="loading-overlay" id="monthly-stats-loading">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Memuat statistik bulanan...</div>
                        </div>
                    </div>
                    <div class="stat-period"><i class="fa-solid fa-calendar"></i> Bulan Ini</div>
                    <div class="row text-center">
                        <div class="col-4 mt-3">
                            <div class="stat-value" id="monthly-new">0</div>
                            <div class="stat-label">Pengguna baru</div>
                        </div>
                        <div class="col-4 mt-3">
                            <div class="stat-value" id="monthly-online">0</div>
                            <div class="stat-label">Pengguna Online</div>
                        </div>
                        <div class="col-4 mt-3">
                            <div class="stat-value" id="monthly-returning">0</div>
                            <div class="stat-label">Pengguna Kembali</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chart Section -->
        <div class="row">
            <!-- Chart Harian -->
            <div class="col-lg-6">
                <div class="chart-panel position-relative">
                    <!-- Loading state for daily chart -->
                    <div class="loading-overlay" id="daily-chart-loading">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Memuat chart harian...</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Chart Mingguan -->
            <div class="col-lg-6">
                <div class="chart-panel position-relative">
                    <!-- Loading state for weekly chart -->
                    <div class="loading-overlay" id="weekly-chart-loading">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Memuat chart mingguan...</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Chart Bulanan -->
            <div class="col-lg-6">
                <div class="chart-panel position-relative">
                    <!-- Loading state for monthly chart -->
                    <div class="loading-overlay" id="monthly-chart-loading">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Memuat chart bulanan...</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Chart Negara -->
            <div class="col-lg-6">
                <div class="chart-panel position-relative">
                    <!-- Loading state for country chart -->
                    <div class="loading-overlay" id="country-chart-loading">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Memuat chart negara...</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="countryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module">
		import {
			initializeApp
		} from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
		import {
			getDatabase,
			ref,
			onValue,
			query,
			orderByChild,
			startAt,
			endAt,
			limitToLast,
			get,
			onChildAdded,
			onChildRemoved
		} from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";

		// Konfigurasi Firebase
		const firebaseConfig = {
			apiKey: "AIzaSyAGX-ehF5pTczVf5rH6tALLWpDhR3JixFE",
			authDomain: "web-analytics-67fbf.firebaseapp.com",
			databaseURL: "https://web-analytics-67fbf-default-rtdb.asia-southeast1.firebasedatabase.app",
			projectId: "web-analytics-67fbf",
			storageBucket: "web-analytics-67fbf.firebasestorage.app",
			messagingSenderId: "603884890926",
			appId: "1:603884890926:web:d9f20d4cd2f639eea2e8bf",
			measurementId: "G-S1L9NR2Z4M"
		};
		
		const app = initializeApp(firebaseConfig, "analytics-dashboard");
		const database = getDatabase(app);

		// Variabel global
		let currentAppId = null;
		let appsList = [];
		let users = [];
		let stats = {
			daily: {
				new: 0,
				online: 0,
				returning: 0,
				countries: {}
			},
			weekly: {
				new: 0,
				online: 0,
				returning: 0,
				countries: {}
			},
			monthly: {
				new: 0,
				online: 0,
				returning: 0,
				countries: {}
			},
			total: {
				new: 0,
				online: 0,
				returning: 0,
				countries: {}
			}
		};

		// Variabel untuk chart
		let dailyChart, weeklyChart, monthlyChart, countryChart;

		// Variabel untuk manajemen listener
		let statsListeners = [];
		let usersListener = null;
		let countryListener = null;
		let chartListeners = [];

		// Variabel untuk state toggle
		let isAppsExpanded = false;
		let filteredApps = [];

		// Variabel untuk virtual scrolling
		let visibleUsers = [];
		let startIndex = 0;
		let endIndex = 0;
		const itemHeight = 60; // Tinggi per item dalam px
		let visibleItemCount = 0;

		// Fungsi untuk menampilkan loading state
		function showLoading(elementId) {
			const element = document.getElementById(elementId);
			if (element) {
				element.style.display = 'flex';
			}
		}

		// Fungsi untuk menyembunyikan loading state
		function hideLoading(elementId) {
			const element = document.getElementById(elementId);
			if (element) {
				element.style.display = 'none';
			}
		}

		// Fungsi untuk memuat daftar aplikasi
		async function loadAppsList() {
			try {
				showLoading('apps-list-loading');

				const appsRef = ref(database, 'globalWebAnalytics/apps');
				const snapshot = await get(appsRef);

				if (snapshot.exists()) {
					const appsData = snapshot.val();
					appsList = Object.keys(appsData).map(key => ({
						id: key,
						name: key.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '),
						path: `globalWebAnalytics/apps/${key}`
					}));

					renderAppsList(); // Ganti dari renderAppsList() sebelumnya

					// Pilih aplikasi pertama secara default
					if (appsList.length > 0 && !currentAppId) {
						currentAppId = appsList[0].id;
						loadAppData(currentAppId);
					}
				} else {
					console.error('Tidak ada data aplikasi ditemukan');
					document.getElementById('apps-list').innerHTML = '<div class="text-center p-3 text-white">Tidak ada aplikasi ditemukan</div>';
				}
			} catch (error) {
				console.error('Error memuat daftar aplikasi:', error);
				document.getElementById('apps-list').innerHTML = '<div class="text-center p-3 text-white">Gagal memuat daftar aplikasi</div>';
			} finally {
				hideLoading('apps-list-loading');
			}
		}

		// Handle resize window untuk reset state
		window.addEventListener('resize', function () {
			if (window.innerWidth >= 1024) {
				// Di desktop, selalu expanded
				isAppsExpanded = true;
				updateToggleButton();
			} else {
				// Di mobile, reset ke collapsed
				isAppsExpanded = false;
				updateToggleButton();
			}
		});

		// Render daftar aplikasi di sidebar
		function renderAppsList() {
			const appsListElement = document.getElementById('apps-list');
			appsListElement.innerHTML = '';

			// Gunakan filteredApps jika ada pencarian,否则 gunakan semua apps
			const appsToShow = filteredApps.length > 0 ? filteredApps : appsList;

			if (appsToShow.length === 0) {
				appsListElement.innerHTML = '<div class="text-center p-3 text-white">Tidak ada aplikasi ditemukan</div>';
				return;
			}

			appsToShow.forEach(app => {
				const listItem = document.createElement('li');
				listItem.className = `list-group-item app-item ${app.id === currentAppId ? 'active' : ''}`;
				listItem.innerHTML = `
							<i class="fa-solid fa-database"></i>
							<span>${app.name}</span>
						`;
				listItem.dataset.appId = app.id;
				listItem.addEventListener('click', () => {
					currentAppId = app.id;
					document.querySelectorAll('.app-item').forEach(item => item.classList.remove('active'));
					listItem.classList.add('active');
					loadAppData(app.id);

					// Reset pencarian setelah memilih app
					document.getElementById('app-search').value = '';
					filteredApps = [];
					updateToggleButton();
				});

				appsListElement.appendChild(listItem);
			});

			// Update tombol toggle
			updateToggleButton();
		}

		// Fungsi untuk update tombol toggle
		function updateToggleButton() {
			const toggleButton = document.getElementById('toggle-apps');
			const appsContainer = document.getElementById('apps-container');
			const appsToShow = filteredApps.length > 0 ? filteredApps : appsList;

			if (appsToShow.length <= 3) {
				toggleButton.style.display = 'none';
				appsContainer.classList.remove('collapsed');
			} else {
				toggleButton.style.display = 'block';

				if (!isAppsExpanded) {
					appsContainer.classList.add('collapsed');
					toggleButton.innerHTML = '<i class="fas fa-chevron-down me-1"></i> Lihat Semua (' + (appsToShow.length - 3) + ')';
				} else {
					appsContainer.classList.remove('collapsed');
					toggleButton.innerHTML = '<i class="fas fa-chevron-up me-1"></i> Sembunyikan';
				}
			}
		}

		// Fungsi untuk filter apps berdasarkan nama
		function filterApps(searchTerm) {
			if (!searchTerm) {
				filteredApps = [];
			} else {
				filteredApps = appsList.filter(app =>
					app.name.toLowerCase().includes(searchTerm.toLowerCase())
				);
			}
			renderAppsList();
		}

		// Event listener untuk pencarian
		document.getElementById('app-search').addEventListener('input', function (e) {
			filterApps(e.target.value);
		});

		// Event listener untuk tombol toggle
		document.getElementById('toggle-apps').addEventListener('click', function () {
			isAppsExpanded = !isAppsExpanded;
			updateToggleButton();
		});

		// Memuat data aplikasi yang dipilih
		async function loadAppData(appId) {
			try {
				// Update judul dashboard
				const appName = appsList.find(app => app.id === appId)?.name;
				document.getElementById('app-title').innerHTML =
					`<i class="fa-solid fa-chart-line"></i> Laporan untuk <span style="color: #009999; font-weight: 900"> ${appName}</span>` || 'Realtime Analytics';

				// Tampilkan loading untuk semua bagian
				showLoading('total-users-loading');
				showLoading('users-list-loading');
				showLoading('country-list-loading');
				showLoading('daily-stats-loading');
				showLoading('weekly-stats-loading');
				showLoading('monthly-stats-loading');
				showLoading('daily-chart-loading');
				showLoading('weekly-chart-loading');
				showLoading('monthly-chart-loading');
				showLoading('country-chart-loading');

				// Muat statistik
				await loadStats(appId);

				// Muat daftar pengguna
				await loadUsers(appId);

				// Muat data chart
				await loadChartData(appId);

				// Muat data negara
				await loadCountryData(appId);
			} catch (error) {
				console.error('Error memuat data aplikasi:', error);
			}
		}

		// Memuat statistik 
		function loadStats(appId) {
			const appPath = `globalWebAnalytics/apps/${appId}`;

			// Format tanggal untuk query
			const now = new Date();
			const today = formatDate(now);
			const thisWeek = formatWeek(now);
			const thisMonth = formatMonth(now);

			// Hapus listener sebelumnya jika ada
			if (statsListeners.length > 0) {
				statsListeners.forEach(unsubscribe => unsubscribe());
				statsListeners = [];
			}

			// Paths untuk statistik harian
			const dailyPaths = {
				new: `${appPath}/stats/newUsers/daily/${today}/total`,
				online: `${appPath}/stats/onlineUsers/daily/${today}/total`,
				returning: `${appPath}/stats/returningUsers/daily/${today}/total`
			};

			// Paths untuk statistik mingguan
			const weeklyPaths = {
				new: `${appPath}/stats/newUsers/weekly/${thisWeek}/total`,
				online: `${appPath}/stats/onlineUsers/weekly/${thisWeek}/total`,
				returning: `${appPath}/stats/returningUsers/weekly/${thisWeek}/total`
			};

			// Paths untuk statistik bulanan
			const monthlyPaths = {
				new: `${appPath}/stats/newUsers/monthly/${thisMonth}/total`,
				online: `${appPath}/stats/onlineUsers/monthly/${thisMonth}/total`,
				returning: `${appPath}/stats/returningUsers/monthly/${thisMonth}/total`
			};

			// Paths untuk statistik total
			const totalPaths = {
				new: `${appPath}/stats/newUsers/total/total`,
				online: `${appPath}/stats/onlineUsers/total/total`,
				returning: `${appPath}/stats/returningUsers/total/total`
			};

			// Fungsi untuk membuat listener untuk satu path
			const createListener = (path, metric, period) => {
				const refPath = ref(database, path);
				const unsubscribe = onValue(refPath, (snapshot) => {
					const count = snapshot.exists() ? snapshot.val().count || 0 : 0;
					stats[period][metric] = count;
					renderStats();

					// Sembunyikan loading setelah data pertama diterima
					if (period === 'daily') hideLoading('daily-stats-loading');
					if (period === 'weekly') hideLoading('weekly-stats-loading');
					if (period === 'monthly') hideLoading('monthly-stats-loading');
				}, (error) => {
					console.error(`Error listening to ${path}:`, error);
				});
				statsListeners.push(unsubscribe);
			};

			// Membuat listener untuk setiap path harian
			Object.keys(dailyPaths).forEach(metric => {
				createListener(dailyPaths[metric], metric, 'daily');
			});

			// Membuat listener untuk setiap path mingguan
			Object.keys(weeklyPaths).forEach(metric => {
				createListener(weeklyPaths[metric], metric, 'weekly');
			});

			// Membuat listener untuk setiap path bulanan
			Object.keys(monthlyPaths).forEach(metric => {
				createListener(monthlyPaths[metric], metric, 'monthly');
			});

			// Membuat listener untuk setiap path total
			Object.keys(totalPaths).forEach(metric => {
				createListener(totalPaths[metric], metric, 'total');
			});
		}

		// Memuat daftar pengguna
		function loadUsers(appId) {
			const appPath = `globalWebAnalytics/apps/${appId}`;
			const usersRef = ref(database, `${appPath}/users`);

			// Hapus listener sebelumnya jika ada
			if (usersListener) {
				usersListener(); // Unsubscribe dari listener sebelumnya
			}

			// Gunakan onValue untuk real-time updates
			usersListener = onValue(usersRef, (snapshot) => {
				if (snapshot.exists()) {
					users = [];
					snapshot.forEach(userSnapshot => {
						const userData = userSnapshot.val();
						const userPresence = userData.UserPresence || {};

						// Ambil IP terbaru untuk mendapatkan negara
						const countryCode = userPresence.countryCode;
						const countryName = userPresence.countryName;
						const lastIP = userPresence.LastIP;

						users.push({
							id: userSnapshot.key,
							status: userPresence.status || "offline",
							lastSeen: userPresence.userLastSeen || 0,
							countryCode: countryCode || countryName || "not set",
							countryName: countryName || countryCode || "not set",
							ip: lastIP
						});
					});

					// Urutkan pengguna: online pertama, lalu offline terbaru
					users.sort((a, b) => {
						if (a.status === 'online' && b.status !== 'online') return -1;
						if (a.status !== 'online' && b.status === 'online') return 1;
						return b.lastSeen - a.lastSeen;
					});

					renderUsers();
					renderTotalUsers();
					hideLoading('users-list-loading');
					hideLoading('total-users-loading');
				} else {
					users = [];
					renderUsers();
					renderTotalUsers();
					hideLoading('users-list-loading');
					hideLoading('total-users-loading');
				}
			}, (error) => {
				console.error('Error memuat daftar pengguna:', error);
				hideLoading('users-list-loading');
				hideLoading('total-users-loading');
			});
		}

		// Memuat data negara 
		function loadCountryData(appId) {
			const statsRef = `globalWebAnalytics/apps/${appId}/stats`;
			const countriesRef = ref(database, `${statsRef}/countries/total`);

			// Hapus listener sebelumnya jika ada
			if (countryListener) {
				countryListener(); // Unsubscribe dari listener sebelumnya
			}

			// Gunakan onValue untuk real-time updates
			countryListener = onValue(countriesRef, (countriesSnapshot) => {
				const countryList = document.getElementById('country-list');

				if (countriesSnapshot.exists()) {
					const countriesData = countriesSnapshot.val();
					const countries = [];

					// Mengumpulkan data negara
					for (const [code, data] of Object.entries(countriesData)) {
						if (code !== 'undefined') { // Filter out undefined
							countries.push({
								countryCode: code,
								count: data.count || 0,
								countryName: data.countryName || code
							});
						}
					}

					// Mengurutkan berdasarkan jumlah tertinggi
					countries.sort((a, b) => b.count - a.count);

					// Menampilkan 1000 negara 
					let html = '';
					countries.slice(0, 1000).forEach(country => {
						html += `
									<div class="d-flex justify-content-between align-items-center mb-2">
										<div>
											<img src="https://flagcdn.com/w20/${country.countryCode.toLowerCase()}.png" class="country-flag" alt="${country.countryCode}">
											<span> ${country.countryName}</span>
											<span><strong> (${country.countryCode})</strong></span>
										</div>
										<span class="badge bg-primary">${formatNumber(country.count)}</span>
									</div>
								`;
					});

					countryList.innerHTML = html;

					// Ambil 5 negara teratas
					const topCountries = countries.slice(0, 5);

					// Buat atau update chart negara
					updateCountryChart(topCountries);
					hideLoading('country-list-loading');
					hideLoading('country-chart-loading');
				} else {
					countryList.innerHTML = '<p class="text-center">No country data available</p>';
					// Reset chart jika tidak ada data
					if (countryChart) {
						countryChart.destroy();
						countryChart = null;
					}
					hideLoading('country-list-loading');
					hideLoading('country-chart-loading');
				}
			}, (error) => {
				console.error("Error loading country data:", error);
				document.getElementById('country-list').innerHTML = '<p class="text-center text-danger">Error loading data</p>';
				hideLoading('country-list-loading');
				hideLoading('country-chart-loading');
			});
		}

		// Memuat data chart 
		function loadChartData(appId) {
			const appPath = `globalWebAnalytics/apps/${appId}`;

			// Hapus listener sebelumnya jika ada
			if (chartListeners.length > 0) {
				chartListeners.forEach(unsubscribe => unsubscribe());
				chartListeners = [];
			}

			// Generate dates untuk 7 hari terakhir, 4 minggu terakhir, 6 bulan terakhir
			const now = new Date();

			// Data untuk 7 hari terakhir
			const dailyDates = [];
			for (let i = 6; i >= 0; i--) {
				const date = new Date(now);
				date.setDate(date.getDate() - i);
				dailyDates.push(formatDate(date));
			}

			// Data untuk 4 minggu terakhir
			const weeklyDates = [];
			for (let i = 3; i >= 0; i--) {
				const date = new Date(now);
				date.setDate(date.getDate() - i * 7);
				weeklyDates.push(formatWeek(date));
			}

			// Data untuk 6 bulan terakhir
			const monthlyDates = [];
			for (let i = 5; i >= 0; i--) {
				const date = new Date(now);
				date.setMonth(date.getMonth() - i);
				monthlyDates.push(formatMonth(date));
			}

			// Fungsi untuk membuat listener untuk satu periode chart
			const createChartListener = (period, dates, metric, dateIndex) => {
				const path = `${appPath}/stats/${metric}Users/${period}/${dates[dateIndex]}/total`;
				const refPath = ref(database, path);

				const unsubscribe = onValue(refPath, (snapshot) => {
					const count = snapshot.exists() ? snapshot.val().count || 0 : 0;

					// Update data chart yang sesuai
					updateChartData(period, metric, dateIndex, count);

					// Render chart yang diperbarui
					renderChart(period);
				}, (error) => {
					console.error(`Error listening to ${path}:`, error);
				});

				chartListeners.push(unsubscribe);
				return unsubscribe;
			};

			// Inisialisasi struktur data chart
			if (!window.chartData) {
				window.chartData = {
					daily: {
						new: [],
						online: [],
						returning: []
					},
					weekly: {
						new: [],
						online: [],
						returning: []
					},
					monthly: {
						new: [],
						online: [],
						returning: []
					}
				};
			}

			// Reset data chart
			window.chartData.daily = {
				new: [],
				online: [],
				returning: []
			};
			window.chartData.weekly = {
				new: [],
				online: [],
				returning: []
			};
			window.chartData.monthly = {
				new: [],
				online: [],
				returning: []
			};

			// Buat listener untuk setiap data point chart
			const metrics = ['new', 'online', 'returning'];
			const periods = [{
					period: 'daily',
					dates: dailyDates,
					labelFunc: formatDailyLabel
				},
				{
					period: 'weekly',
					dates: weeklyDates,
					labelFunc: formatWeeklyLabel
				},
				{
					period: 'monthly',
					dates: monthlyDates,
					labelFunc: formatMonthlyLabel
				}
			];

			periods.forEach(({
				period,
				dates,
				labelFunc
			}) => {
				metrics.forEach(metric => {
					// Inisialisasi array dengan nilai default 0
					window.chartData[period][metric] = new Array(dates.length).fill(0);

					// Buat listener untuk setiap tanggal dalam periode
					dates.forEach((date, index) => {
						createChartListener(period, dates, metric, index);
					});
				});

				// Render chart awal setelah data dimuat
				setTimeout(() => {
					renderChart(period);
					if (period === 'daily') hideLoading('daily-chart-loading');
					if (period === 'weekly') hideLoading('weekly-chart-loading');
					if (period === 'monthly') hideLoading('monthly-chart-loading');
				}, 100);
			});
		}

		// Update data chart ketika ada perubahan
		function updateChartData(period, metric, dateIndex, count) {
			if (window.chartData && window.chartData[period] && window.chartData[period][metric]) {
				window.chartData[period][metric][dateIndex] = count;
			}
		}

		// Render chart berdasarkan periode
		function renderChart(period) {
			const dates = getDatesForPeriod(period);
			const labels = formatChartLabels(period, dates);
			const data = window.chartData[period];

			switch (period) {
				case 'daily':
					updateDailyChart(labels, data);
					break;
				case 'weekly':
					updateWeeklyChart(labels, data);
					break;
				case 'monthly':
					updateMonthlyChart(labels, data);
					break;
			}
		}

		// Fungsi utilitas untuk chart
		function getDatesForPeriod(period) {
			const now = new Date();

			switch (period) {
				case 'daily':
					const dailyDates = [];
					for (let i = 6; i >= 0; i--) {
						const date = new Date(now);
						date.setDate(date.getDate() - i);
						dailyDates.push(formatDate(date));
					}
					return dailyDates;

				case 'weekly':
					const weeklyDates = [];
					for (let i = 3; i >= 0; i--) {
						const date = new Date(now);
						date.setDate(date.getDate() - i * 7);
						weeklyDates.push(formatWeek(date));
					}
					return weeklyDates;

				case 'monthly':
					const monthlyDates = [];
					for (let i = 5; i >= 0; i--) {
						const date = new Date(now);
						date.setMonth(date.getMonth() - i);
						monthlyDates.push(formatMonth(date));
					}
					return monthlyDates;

				default:
					return [];
			}
		}

		function formatChartLabels(period, dates) {
			switch (period) {
				case 'daily':
					return dates.map(date => {
						const year = date.substring(0, 4);
						const month = date.substring(4, 6);
						const day = date.substring(6, 8);
						return `${day}/${month}`;
					});

				case 'weekly':
					return dates.map(week => `Minggu ${week.split('W')[1]}`);

				case 'monthly':
					return dates.map(month => {
						const year = month.substring(0, 4);
						const monthNum = month.substring(4, 6);
						const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
						return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
					});

				default:
					return dates;
			}
		}

		// Fungsi format label yang spesifik (jika diperlukan)
		function formatDailyLabel(date) {
			const year = date.substring(0, 4);
			const month = date.substring(4, 6);
			const day = date.substring(6, 8);
			return `${day}/${month}`;
		}

		function formatWeeklyLabel(week) {
			return `Minggu ${week.split('W')[1]}`;
		}

		function formatMonthlyLabel(month) {
			const year = month.substring(0, 4);
			const monthNum = month.substring(4, 6);
			const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
			return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
		}

		// Update chart harian
		function updateDailyChart(labels, data) {
			const ctx = document.getElementById('dailyChart').getContext('2d');

			if (dailyChart) {
				dailyChart.destroy();
			}

			dailyChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: [{
							label: 'Pengguna Baru',
							data: data.new,
							borderColor: '#4cc9f0',
							backgroundColor: 'rgba(76, 201, 240, 0.1)',
							tension: 0.3,
							fill: true
						},
						{
							label: 'Pengguna Online',
							data: data.online,
							borderColor: '#3a0ca3',
							backgroundColor: 'rgba(58, 12, 163, 0.1)',
							tension: 0.3,
							fill: true
						},
						{
							label: 'Pengguna Kembali',
							data: data.returning,
							borderColor: '#f72585',
							backgroundColor: 'rgba(247, 37, 133, 0.1)',
							tension: 0.3,
							fill: true
						}
					]
				},
				options: {
					maintainAspectRatio: false,
					plugins: {
						title: {
							display: true,
							text: 'Statistik Harian (7 Hari Terakhir)'
						},
						legend: {
							position: 'top',
						}
					}
				}
			});
		}

		// Update chart mingguan
		function updateWeeklyChart(labels, data) {
			const ctx = document.getElementById('weeklyChart').getContext('2d');

			if (weeklyChart) {
				weeklyChart.destroy();
			}

			weeklyChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: [{
							label: 'Pengguna Baru',
							data: data.new,
							borderColor: '#4cc9f0',
							backgroundColor: 'rgba(76, 201, 240, 0.1)',
							tension: 0.3,
							fill: true
						},
						{
							label: 'Pengguna Online',
							data: data.online,
							borderColor: '#3a0ca3',
							backgroundColor: 'rgba(58, 12, 163, 0.1)',
							tension: 0.3,
							fill: true
						},
						{
							label: 'Pengguna Kembali',
							data: data.returning,
							borderColor: '#f72585',
							backgroundColor: 'rgba(247, 37, 133, 0.1)',
							tension: 0.3,
							fill: true
						}
					]
				},
				options: {
					maintainAspectRatio: false,
					plugins: {
						title: {
							display: true,
							text: `Statistik Mingguan (4 Minggu Terakhir)`
						},
						legend: {
							position: 'top',
						}
					}
				}
			});
		}

		// Update chart bulanan
		function updateMonthlyChart(labels, data) {
			const ctx = document.getElementById('monthlyChart').getContext('2d');

			if (monthlyChart) {
				monthlyChart.destroy();
			}

			monthlyChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: [{
							label: 'Pengguna Baru',
							data: data.new,
							borderColor: '#4cc9f0',
							backgroundColor: 'rgba(76, 201, 240, 0.1)',
							tension: 0.3,
							fill: true
						},
						{
							label: 'Pengguna Online',
							data: data.online,
							borderColor: '#3a0ca3',
							backgroundColor: 'rgba(58, 12, 163, 0.1)',
							tension: 0.3,
							fill: true
						},
						{
							label: 'Pengguna Kembali',
							data: data.returning,
							borderColor: '#f72585',
							backgroundColor: 'rgba(247, 37, 133, 0.1)',
							tension: 0.3,
							fill: true
						}
					]
				},
				options: {
					maintainAspectRatio: false,
					plugins: {
						title: {
							display: true,
							text: 'Statistik Bulanan (6 Bulan Terakhir)'
						},
						legend: {
							position: 'top',
						}
					}
				}
			});
		}

		// Update chart negara
		function updateCountryChart(countries) {
			const ctx = document.getElementById('countryChart').getContext('2d');

			if (countryChart) {
				countryChart.destroy();
			}

			const labels = countries.map(country => country.countryName);
			const data = countries.map(country => country.count);
			const backgroundColors = [
				'#4361ee', '#4cc9f0', '#3a0ca3', '#f72585', '#7209b7',
				'#4895ef', '#560bad', '#b5179e', '#f15bb5', '#00bbf9'
			];

			countryChart = new Chart(ctx, {
				type: 'doughnut',
				data: {
					labels: labels,
					datasets: [{
						data: data,
						backgroundColor: backgroundColors
					}]
				},
				options: {
					maintainAspectRatio: false,
					plugins: {
						title: {
							display: true,
							text: 'Top 5 Negara Pengguna'
						},
						legend: {
							position: 'top',
						}
					}
				}
			});
		}

		// Render statistik
		function renderStats() {
			// Update counter untuk setiap periode
			document.getElementById('daily-new').textContent = stats.daily.new;
			document.getElementById('daily-online').textContent = stats.daily.online;
			document.getElementById('daily-returning').textContent = stats.daily.returning;

			document.getElementById('weekly-new').textContent = stats.weekly.new;
			document.getElementById('weekly-online').textContent = stats.weekly.online;
			document.getElementById('weekly-returning').textContent = stats.weekly.returning;

			document.getElementById('monthly-new').textContent = stats.monthly.new;
			document.getElementById('monthly-online').textContent = stats.monthly.online;
			document.getElementById('monthly-returning').textContent = stats.monthly.returning;
		}

		function renderTotalUsers() {
			const totalUser = document.getElementById('total-user-count');
			totalUser.textContent = `${users.length}`;
		}
		// Render daftar pengguna
		// Render daftar pengguna dengan virtual scrolling
		function renderUsers() {
			const totalUser = document.getElementById('total-user-count');
			const showOfflineToggle = document.getElementById('show-offline');
			const showOfflinLabel = document.getElementById('show-offline-label');
			const showOffline = showOfflineToggle.checked;

			// Filter users berdasarkan toggle
			visibleUsers = showOffline ? users : users.filter(user => user.status !== 'offline');

			showOfflinLabel.innerHTML = showOffline ?
				'<i class="bi bi-eye"></i> Tampilkan Online Saja' :
				'<i class="bi bi-eye"></i> Tampilkan Semua';

			if (visibleUsers.length === 0) {
				const virtualContainer = document.getElementById('users-list-virtual');
				if (virtualContainer) {
					virtualContainer.innerHTML = '<div class="text-center p-3 text-muted">Tidak ada pengguna online</div>';
				}
				return;
			}

			totalUser.textContent = `${users.length}`;

			// Setup virtual scrolling pertama kali
			if (!window.virtualScrollInitialized) {
				calculateVisibleItems();
				setupVirtualScroll();
				window.virtualScrollInitialized = true;
			}

			// Update virtual list
			updateVirtualList();
		}

		// Fungsi untuk menghitung berapa item yang bisa ditampilkan
		function calculateVisibleItems() {
			const container = document.getElementById('users-list');
			if (!container) return 10; // default fallback

			const containerHeight = container.clientHeight;
			visibleItemCount = Math.ceil(containerHeight / itemHeight) + 2; // +2 untuk buffer
			return visibleItemCount;
		}

		// Fungsi untuk update virtual list
		function updateVirtualList() {
			const virtualContainer = document.getElementById('users-list-virtual');
			const container = document.getElementById('users-list');

			if (!virtualContainer || !container) return;

			// Hitung indeks yang terlihat
			const scrollTop = container.scrollTop;
			startIndex = Math.max(0, Math.floor(scrollTop / itemHeight) - 1);
			endIndex = Math.min(visibleUsers.length, startIndex + visibleItemCount + 2);

			// Set tinggi virtual container
			virtualContainer.style.height = `${visibleUsers.length * itemHeight}px`;

			// Render hanya item yang terlihat
			renderVisibleItems(startIndex, endIndex);
		}

		// Fungsi untuk render item yang terlihat saja
		function renderVisibleItems(start, end) {
			const virtualContainer = document.getElementById('users-list-virtual');
			if (!virtualContainer) return;

			virtualContainer.innerHTML = '';

			for (let i = start; i < end; i++) {
				if (i >= visibleUsers.length) break;

				const user = visibleUsers[i];
				const userItem = createUserItem(user, i);
				virtualContainer.appendChild(userItem);
			}
		}

		// Fungsi untuk membuat user item dengan posisi absolute
		function createUserItem(user, index) {
			const userItem = document.createElement('div');
			userItem.className = 'user-item';
			userItem.dataset.userId = user.id;

			const lastSeenText = `${formatLastSeen(user.lastSeen)}`;

			userItem.innerHTML = `
				<div class="d-flex position-relative" style="height:100%">
					<div class="user-item-overlay" style="background-image: url('https://flagcdn.com/w80/${user.countryCode.toLowerCase()}.png');"></div>
					
					<div class="d-flex flex-column flex-grow-1" style="gap:5px; position: relative; z-index: 1;">
						<div>
							<span class="user-uid"> UID: ${user.id}</span>
						</div>
						<div style="font-size:0.7rem">
							<img src="https://flagcdn.com/w20/${user.countryCode.toLowerCase()}.png" 
								 class="mini-country-flag me-2" 
								 alt="${user.countryCode}" 
								 onerror="this.style.display='none'">
							<span class="user-list-country-name"><em>${user.countryName}</em></span>
							<span class="user-list-country-code"><strong><em>(${user.countryCode})</em></strong></span>
						</div>
					</div>
					
					<div class="d-flex flex-column align-items-end" style="width: 100px; gap:5px; position: relative; z-index: 1;">
						<span class="badge bg-${getStatusColor(user.status)}" style="width:50px">${user.status}</span>
						<span class="last-seen" style="font-size:0.7rem"><em>${lastSeenText}</em></span>						
					</div>
				</div>
			`;

			userItem.addEventListener('click', () => showUserDetails(user.id));
			return userItem;
		}

		// Event listener untuk scroll
		function setupVirtualScroll() {
			const container = document.getElementById('users-list');
			if (!container) return;

			// Debounce scroll event untuk performa
			let scrollTimeout;
			container.addEventListener('scroll', () => {
				clearTimeout(scrollTimeout);
				scrollTimeout = setTimeout(() => {
					updateVirtualList();
				}, 100);
			});

			// Juga update saat resize
			window.addEventListener('resize', () => {
				calculateVisibleItems();
				updateVirtualList();
			});
		}

		// Tampilkan detail pengguna 
		async function showUserDetails(userId) {
			const appPath = `globalWebAnalytics/apps/${currentAppId}`;
			const userRef = ref(database, `${appPath}/users/${userId}`);

			try {
				const snapshot = await get(userRef);

				if (snapshot.exists()) {
					const userData = snapshot.val();
					const userPresence = userData.UserPresence || {};
					const ipHistory = userData.IPHistory || {};
					const uidHistory = userData.FirebaseUIDHistory || {};

					// Format data untuk ditampilkan
					const userDetails = {
						id: userId,
						status: userPresence.status || "unknown",
						lastSeen: formatLastSeen(userPresence.userLastSeen || 0),
						countryCode: userPresence.countryCode || userPresence.countryName,
						countryName: userPresence.countryName || userPresence.countryCode,
						lastIP: userPresence.LastIP || "unknown",
						lastFirebaseUID: userPresence.LastFirebaseUID || "unknown",
						ipHistory: Object.keys(ipHistory).map(ip => ({
							ip: ip,
							countryCode: ipHistory[ip].countryCode || "unknown",
							timestamp: formatTimestamp(ipHistory[ip].timestamp || 0)
						})),
						uidHistory: Object.keys(uidHistory).map(uid => ({
							uid: uid,
							timestamp: formatTimestamp(uidHistory[uid].timestamp || 0)
						}))
					};

					// Tampilkan modal dengan detail pengguna
					showUserModal(userDetails);
				}
			} catch (error) {
				console.error('Error memuat detail pengguna:', error);
			}
		}

		// Tampilkan modal dengan detail pengguna
		function showUserModal(userDetails) {
			// Hapus modal sebelumnya jika ada
			const existingModal = document.getElementById('userModal');
			if (existingModal) {
				existingModal.remove();
			}

			// Buat modal HTML
			const modalHTML = `
						<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
							<div class="modal-dialog modal-lg">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="userModalLabel">Detail Pengguna UID: ${userDetails.id}</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>
									<div class="modal-body">
										<div class="row mb-3">
											<div class="col-md-6">
												<strong>Status:</strong> 
												<span class="badge bg-${getStatusColor(userDetails.status)}">${userDetails.status}</span>
											</div>
											<div class="col-md-6">
												<strong>Terakhir Dilihat:</strong> ${userDetails.lastSeen}
											</div>
										</div>
										<div class="row mb-3">
											<div class="col-md-6">
												<strong>Negara:</strong> 
												<img src="https://flagcdn.com/w20/${userDetails.countryCode.toLowerCase()}.png" 
													 class="country-flag ms-1" alt="${userDetails.countryCode}" 
													 onerror="this.style.display='none'">
												${userDetails.countryName} <strong>(${userDetails.countryCode})</strong>
											</div>
											<div class="col-md-6">
												<strong>IP Terakhir:</strong> ${userDetails.lastIP}
											</div>
										</div>
										
										<div class="mb-3">
											<h6>Riwayat IP</h6>
											<div class="table-responsive">
												<table class="table table-sm">
													<thead>
														<tr>
															<th>IP</th>
															<th>Negara</th>
															<th>Waktu</th>
														</tr>
													</thead>
													<tbody>
														${userDetails.ipHistory.map(ip => `
															<tr>
																<td>${ip.ip}</td>
																<td>
																	<img src="https://flagcdn.com/w20/${ip.countryCode.toLowerCase()}.png" 
																		 class="country-flag me-1" alt="${ip.countryCode}" 
																		 onerror="this.style.display='none'">
																	${userDetails.countryName} <strong>(${userDetails.countryCode})</strong>
																</td>
																<td>${ip.timestamp}</td>
															</tr>
														`).join('')}
													</tbody>
												</table>
											</div>
										</div>
										
										<div class="mb-3">
											<h6>Riwayat Firebase UID</h6>
											<div class="table-responsive">
												<table class="table table-sm">
													<thead>
														<tr>
															<th>UID</th>
															<th>Waktu</th>
														</tr>
													</thead>
													<tbody>
														${userDetails.uidHistory.map(uid => `
															<tr>
																<td><code>${uid.uid}</code></td>
																<td>${uid.timestamp}</td>
															</tr>
														`).join('')}
													</tbody>
												</table>
											</div>
										</div>
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
									</div>
								</div>
							</div>
						</div>
					`;

			// Tambahkan modal ke body
			document.body.insertAdjacentHTML('beforeend', modalHTML);

			// Tampilkan modal
			const userModal = new bootstrap.Modal(document.getElementById('userModal'));
			userModal.show();

			// Hapus modal dari DOM setelah ditutup
			document.getElementById('userModal').addEventListener('hidden.bs.modal', function () {
				this.remove();
			});
		}

		// Fungsi utilitas
		function formatDate(date) {
			return `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, "0")}${String(date.getDate()).padStart(2, "0")}`;
		}

		function formatWeek(date) {
			const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
			const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
			const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
			return `${date.getFullYear()}W${String(weekNumber).padStart(2, "0")}`;
		}

		function formatMonth(date) {
			return `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, "0")}`;
		}

		// Fungsi untuk memformat angka
		function formatNumber(num) {
			if (num >= 1000000) {
				return (num / 1000000).toFixed(1) + 'M';
			}
			if (num >= 1000) {
				return (num / 1000).toFixed(1) + 'K';
			}
			return num;
		}

		function formatLastSeen(timestamp) {
			if (!timestamp) return 'Tidak diketahui';

			const now = Date.now();
			const diffMs = now - timestamp;
			const diffMins = Math.floor(diffMs / 60000);
			const diffHours = Math.floor(diffMs / 3600000);
			const diffDays = Math.floor(diffMs / 86400000);

			if (diffMins < 1) return 'Baru saja';
			if (diffMins < 60) return `${diffMins} menit lalu`;
			if (diffHours < 24) return `${diffHours} jam lalu`;
			return `${diffDays} hari lalu`;
		}

		function formatTimestamp(timestamp) {
			if (!timestamp) return 'Tidak diketahui';
			return new Date(timestamp).toLocaleString('id-ID');
		}

		function getStatusColor(status) {
			switch (status) {
				case 'online':
					return 'success';
				case 'idle':
					return 'warning';
				case 'offline':
					return 'secondary';
				default:
					return 'secondary';
			}
		}

		// Event listeners
		document.getElementById('show-offline').addEventListener('change', renderUsers);

		// Inisialisasi dashboard
		document.addEventListener('DOMContentLoaded', () => {
			loadAppsList();

			// Set initial state untuk mobile
			if (window.innerWidth < 1024) {
				isAppsExpanded = false;
			} else {
				isAppsExpanded = true;
			}
		});
    </script>
</body>
</html>
