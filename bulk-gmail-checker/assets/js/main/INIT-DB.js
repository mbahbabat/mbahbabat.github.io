async function STARTSYSTEM(){blockUpdateMessages(!0),loadingState.classList.remove("hideSmooth","hidden");const t="gmailChecker_apiData";function e(){try{const e=localStorage.getItem(t);if(!e)return null;const a=JSON.parse(e);return Date.now()-a.timestamp>31104e6?null:a}catch(t){return console.error("Error parsing cached API data:",t),null}}const a=e();if(a&&a.apiKey)return APIKEY=a.apiKey,START(),window.handleGenerateKey=async()=>({APIKEY:a.apiKey}),blockUpdateMessages(!1),loadingState.classList.add("hideSmooth"),void setTimeout((()=>{loadingState.classList.add("hidden"),"function"==typeof getApiStatsData&&getApiStatsData(),"function"==typeof initHistorySystem&&initHistorySystem()}),500);setTimeout((async function(){const{initializeApp:a}=await import("https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js"),{getAuth:n,signInAnonymously:i,onAuthStateChanged:o}=await import("https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js"),{captchaSolver:r}=await import("../init/captcha.js"),{syncUser:s}=await import("../init/syncUser.js");let c,l,u=null,w=null,f=!1,y=null,d=null;async function h(){return d||(d=new Promise((async(t,e)=>{if(f)return t();try{f=!0;const e=localStorage.getItem("config");if(e)try{const i=JSON.parse(e);return c||(c=a(i),l=n(c)),void g(t)}catch(t){console.warn("Cached Firebase config is invalid, fetching fresh",t),localStorage.removeItem("config")}await p(),g(t)}catch(t){console.error("Firebase init error:",t),u=null,alert(`ðŸ”¥ Initialization failed: ${t.message}`),e(t)}finally{f=!1}})),d)}async function p(t=null){let e={};if(!u){const t=await fetch(`${DB_URL}/firebase-config`,{method:"GET"});if(!t.ok)throw new Error(`Challenge request failed: ${t.status}`);u=await t.json()}const i=`${u.nonce}:${u.salt}`,o=await async function(t,e){try{const a=new TextEncoder,n=await crypto.subtle.importKey("raw",a.encode(e),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),i=await crypto.subtle.sign("HMAC",n,a.encode(t));return btoa(String.fromCharCode(...new Uint8Array(i))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw console.error("HMAC generation error:",t),new Error("Failed to generate HMAC signature")}}(i,u.tempToken);e={token:u.tempToken,nonce:u.nonce,signature:o},t&&(e.captchaValue=t);const s=await fetch(`${DB_URL}/firebase-config`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(s.ok){const t=await s.json();return localStorage.setItem("config",JSON.stringify(t)),c||(c=a(t),l=n(c)),void await m()}const w=await s.json();switch(s.status){case 428:case 403:if(!w.captchaRequired&&428!==s.status)throw new Error(w.error||"Akses ditolak (403)");{const t=await r.solve(w.captchaData,403===s.status);u=null,await p(t)}break;case 429:throw alert(`ðŸ”¥ ${w.error}`),new Error("Rate limited");default:throw u=null,new Error(w.error||`Config request failed with status: ${s.status}`)}}function g(t){o(l,(async e=>{w=e,w?(await s(DB_URL,w,{forceFullUpdate:!0}),console.warn(" USER SYNCHRONIZING ..."),y=await w.getIdToken(!0),t&&(t(),t=null)):await m()}))}async function m(){let t=0;for(;t<3;)try{return void await i(l)}catch(e){if(console.error(`Attempt ${t+1} to sign in anonymously failed:`,e),t++,!(t<3))throw console.error("Failed to sign in anonymously after multiple attempts."),e;await new Promise((t=>setTimeout(t,1e3)))}}async function S(){if(d?await d:(console.warn("initFirebase was not called before handleGenerateKey. Initializing Firebase now..."),await h()),!w||!y){console.warn("currentUser or idToken not available after Firebase initialization. Attempting anonymous sign-in.");try{await m()}catch(t){throw new Error("Failed to get authenticated user or ID token after Firebase initialization.")}}const a=e();if(a&&a.apiKey)return APIKEY=a.apiKey,{APIKEY:a.apiKey};try{const e=await fetch(`${SERVER_URL}/generate-free-key`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${y}`}});if(!e.ok)throw new Error(`HTTP ${e.status}`);const a=await e.json();return APIKEY=a.apiKey,function(e){localStorage.setItem(t,JSON.stringify({...e,timestamp:Date.now()}))}({apiKey:APIKEY,type:"free"}),{APIKEY:APIKEY}}catch(t){throw console.error("Generate API Key error:",t),t}}await async function(){try{await h(),await S()}catch(t){console.error("Failed to initialize Firebase or get API Key:",t)}}(),START(),window.handleGenerateKey=S,blockUpdateMessages(!1),loadingState.classList.add("hideSmooth"),setTimeout((function(){loadingState.classList.add("hidden")}),500),setTimeout((()=>{"function"==typeof getApiStatsData&&getApiStatsData(),"function"==typeof initHistorySystem&&initHistorySystem()}),1e3)}),systemDelay+1e3)}STARTSYSTEM();