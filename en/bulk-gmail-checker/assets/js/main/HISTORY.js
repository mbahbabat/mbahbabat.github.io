const DB_NAME="GmailCheckerHistory",DB_VERSION=1,STORE_NAME="checkHistory";let db=null;async function initDB(){return new Promise(((e,t)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);r.onerror=()=>t(r.error),r.onsuccess=()=>{db=r.result,e(db)},r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(STORE_NAME)){const e=t.createObjectStore(STORE_NAME,{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("filename","filename",{unique:!1})}}}))}function generateFilename(e){const t=new Date;return`History-${e}emails-BulkGmailChecker_${t.toISOString().slice(0,10).replace(/-/g,"-")}_${t.toTimeString().slice(0,8).replace(/:/g,"-")}`}async function saveCheckHistory(e,t){db||await initDB();try{const r=db.transaction([STORE_NAME],"readwrite").objectStore(STORE_NAME),s={timestamp:Date.now(),filename:generateFilename(e.length),emailCount:e.length,results:e,serverInfo:t,stats:{live:e.filter((e=>"live"===e.status)).length,verify:e.filter((e=>"verify"===e.status)).length,disabled:e.filter((e=>"disabled"===e.status)).length,unregistered:e.filter((e=>"unregistered"===e.status)).length,bad:e.filter((e=>"bad"===e.status)).length}},o=r.add(s);return new Promise(((e,t)=>{o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}))}catch(e){throw console.error("Error saving history:",e),e}}async function getAllHistory(){return db||await initDB(),new Promise(((e,t)=>{const r=db.transaction([STORE_NAME],"readonly").objectStore(STORE_NAME).index("timestamp").openCursor(null,"prev"),s=[];r.onsuccess=t=>{const r=t.target.result;r?(s.push(r.value),r.continue()):e(s)},r.onerror=()=>t(r.error)}))}async function getHistoryItem(e){return db||await initDB(),new Promise(((t,r)=>{const s=db.transaction([STORE_NAME],"readonly").objectStore(STORE_NAME).get(e);s.onsuccess=()=>t(s.result),s.onerror=()=>r(s.error)}))}async function deleteHistoryItem(e){return db||await initDB(),new Promise(((t,r)=>{const s=db.transaction([STORE_NAME],"readwrite").objectStore(STORE_NAME).delete(e);s.onsuccess=()=>t(),s.onerror=()=>r(s.error)}))}async function clearAllHistory(){return db||await initDB(),new Promise(((e,t)=>{const r=db.transaction([STORE_NAME],"readwrite").objectStore(STORE_NAME).clear();r.onsuccess=()=>e(),r.onerror=()=>t(r.error)}))}function formatDate(e){return new Date(e).toLocaleString()}async function loadHistory(){try{await new Promise((e=>setTimeout(e,50)));const e=document.getElementById("history-list"),t=document.getElementById("total-checks"),r=document.getElementById("total-emails");if(!e||!t||!r)return console.error("History elements not found in DOM"),myAccountModal?void 0:(await createMyAccountModal(),await loadHistory());e.innerHTML="<p>Loading history...</p>";const s=await getAllHistory();t.textContent=`Total: ${s.length}`;const o=s.reduce(((e,t)=>e+t.emailCount),0);if(r.textContent=`Emails: ${o}`,0===s.length)return void(e.innerHTML=' <div class="empty-history"> <i class="fas fa-history fa-2x" style="margin-bottom: 10px;"></i> <p>No check history found</p> <p style="font-size: 0.9em;">Your check results will appear here</p> </div> ');let i="";s.forEach((e=>{i+=` <div class="history-item" data-id="${e.id}"> <div class="history-info"> <div class="history-filename">${e.filename}</div> <div class="history-meta"> <span>${formatDate(e.timestamp)}</span> <span>${e.emailCount} emails</span> <span>Live: ${e.stats.live}</span> <span>Verify: ${e.stats.verify}</span> <span>Disabled: ${e.stats.disabled}</span> <span>Unregistered: ${e.stats.unregistered}</span> <span>Bad: ${e.stats.bad}</span> </div> </div> <div class="history-actions"> <button class="history-btn open" title="Open in results"> <i class="fas fa-folder-open"></i> </button> <button class="history-btn copy" title="Copy results"> <i class="fas fa-copy"></i> </button> <button class="history-btn download" title="Download results"> <i class="fas fa-download"></i> </button> <button class="history-btn delete" title="Delete history"> <i class="fas fa-trash"></i> </button> </div> </div> `})),e.innerHTML=i,document.querySelectorAll(".history-item").forEach((e=>{const t=parseInt(e.dataset.id);e.querySelector(".history-btn.open").addEventListener("click",(()=>openHistoryItem(t))),e.querySelector(".history-btn.copy").addEventListener("click",(()=>copyHistoryItem(t))),e.querySelector(".history-btn.download").addEventListener("click",(()=>downloadHistoryItem(t))),e.querySelector(".history-btn.delete").addEventListener("click",(()=>deleteHistoryItemUI(t)))}))}catch(e){console.error("Error loading history:",e);const t=document.getElementById("history-list");t&&(t.innerHTML='<p class="status-error">Error loading history</p>')}}async function openHistoryItem(e){try{const t=await getHistoryItem(e);if(!t)return void alert("History item not found");if(results=t.results,t.serverInfo){t.serverInfo.isNormalServer?(verifyFilterBtn.classList.remove("hidden"),unregisteredFilterBtn.classList.remove("hidden"),disabledFilterBtn.classList.remove("hidden")):(verifyFilterBtn.classList.add("hidden"),unregisteredFilterBtn.classList.add("hidden"),disabledFilterBtn.classList.add("hidden"))}else verifyFilterBtn.classList.remove("hidden"),unregisteredFilterBtn.classList.remove("hidden"),disabledFilterBtn.classList.remove("hidden");updateCounters(),displayResults(),inputSection.classList.add("hidden"),outputSection.classList.remove("hidden"),inputButtonContainer.classList.add("hidden"),outputButtonContainer.classList.remove("hidden"),closeMyAccountModal(),systemMessage.textContent=`${t.filename}`,resultTitle.textContent="RESULTS HISTORY",backgroundGlow.style.cssText="background: radial-gradient(circle, rgba(255, 190, 0, 0.2) 0%, rgba(120, 192, 219, 1) 60%, rgba(255, 107, 0, 0.3) 100%);animation: pulseGlow 10s infinite alternate ease-in-out;",document.querySelector("main").style.background="#665200",serverSelectionContainer.classList.add("hidden")}catch(e){console.error("Error opening history item:",e),alert("Failed to open history item")}}async function copyHistoryItem(e){try{const t=await getHistoryItem(e);if(!t)return void alert("History item not found");const r=t.results.map((e=>e.email)).join("\n");await navigator.clipboard.writeText(r);const s=event.target.closest(".history-btn.copy"),o=s.innerHTML;s.innerHTML='<i class="fas fa-check"></i>',s.style.backgroundColor="rgba(0, 255, 127, 0.4)",setTimeout((()=>{s.innerHTML=o,s.style.backgroundColor=""}),2e3)}catch(e){console.error("Error copying history item:",e),alert("Failed to copy history item")}}async function downloadHistoryItem(e){try{const t=await getHistoryItem(e);if(!t)return void alert("History item not found");const r=t.results.map((e=>e.email)).join("\n"),s=new Blob([r],{type:"text/plain"}),o=URL.createObjectURL(s),i=document.createElement("a");i.href=o,i.download=`${t.filename}.txt`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}catch(e){console.error("Error downloading history item:",e),alert("Failed to download history item")}}async function deleteHistoryItemUI(e){if(confirm("Are you sure you want to delete this history item?"))try{await deleteHistoryItem(e);const t=document.querySelector(`.history-item[data-id="${e}"]`);t&&(t.style.opacity="0.5",setTimeout((()=>{t.remove(),loadHistory()}),300))}catch(e){console.error("Error deleting history item:",e),alert("Failed to delete history item")}}async function clearAllHistoryUI(){if(confirm("Are you sure you want to clear all history? This action cannot be undone."))try{await clearAllHistory(),await loadHistory()}catch(e){console.error("Error clearing history:",e),alert("Failed to clear history")}}async function initHistorySystem(){try{await initDB()}catch(e){console.error("Failed to initialize history system:",e)}}async function saveCurrentResults(){if(results&&results.length>0)try{const e={serverType:selectedServer,isNormalServer:"server1"===selectedServer||"server2"===selectedServer};await saveCheckHistory(results,e)}catch(e){console.error("Failed to save results to history:",e)}}