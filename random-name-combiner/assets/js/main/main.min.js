const SERVER_URL="https://names-combiner.mbahbabat.workers.dev",CACHE_DURATION=864e5,cacheUtils={set:(e,t)=>{try{const n={data:t,timestamp:Date.now()};return localStorage.setItem(e,JSON.stringify(n)),!0}catch(e){return console.warn("LocalStorage set failed:",e),!1}},get:e=>{try{const t=localStorage.getItem(e);if(!t)return null;const n=JSON.parse(t);return Date.now()-n.timestamp>864e5?(localStorage.removeItem(e),null):n.data}catch(e){return console.warn("LocalStorage get failed:",e),null}},remove:e=>{try{return localStorage.removeItem(e),!0}catch(e){return console.warn("LocalStorage remove failed:",e),!1}}},serverUtils={getAccessToken:async()=>{const e=await fetch(`${SERVER_URL}/get-accessToken`);return(await e.json()).accessToken}},inputEditor=CodeMirror.fromTextArea(document.getElementById("inputEditor"),{lineNumbers:!0,mode:"text/plain",lineWrapping:!0,placeholder:"Enter name here, supports multiple names in one line"}),outputEditor=CodeMirror.fromTextArea(document.getElementById("outputEditor"),{lineNumbers:!0,mode:"text/plain",lineWrapping:!0,readOnly:!0,placeholder:"Generated combinations will appear here..."}),randomBtn=document.getElementById("randomBtn"),resetBtn=document.getElementById("resetBtn"),copyBtn=document.getElementById("copyBtn"),downloadBtn=document.getElementById("downloadBtn"),pasteBtn=document.getElementById("pasteBtn"),progressContainer=document.getElementById("progressContainer"),progressFill=document.getElementById("progressFill"),progressText=document.getElementById("progressText"),reverseCheckbox=document.getElementById("reverseCheckbox"),inputControls=document.getElementById("input-controls"),outputControls=document.getElementById("output-controls"),editorContainer=document.getElementById("editor-container"),errorContainer=document.getElementById("errorContainer"),errorList=document.getElementById("errorList"),fixInputBtn=document.getElementById("fixInputBtn");let currentErrors={};function isMobile(){return window.innerWidth<=768}function cleanWord(e){return e.replace(/[^a-zA-Z]/g,"")}function parseInput(e){const t=e.split(/[\s\n]+/).filter((e=>""!==e.trim())),n=new Set,o=[],r={duplicates:[],unallowed:[]};t.forEach((e=>{const t=cleanWord(e),a=t.toLowerCase();""!==t&&(t!==e&&(r.unallowed.some((t=>t.original===e))||r.unallowed.push({original:e,cleaned:t})),n.has(a)?r.duplicates.some((t=>t.original===e))||r.unallowed.some((t=>t.cleaned.toLowerCase()===a&&t.original!==e))||r.duplicates.push({original:e,cleaned:t}):(n.add(a),o.push(t)))}));const a=[],i=new Set;return o.forEach((e=>{const t=e.toLowerCase(),n=r.duplicates.some((e=>e.cleaned.toLowerCase()===t)),o=r.unallowed.some((e=>e.cleaned.toLowerCase()===t));i.has(t)||n||o||(a.push(e),i.add(t))})),{words:a,errors:r}}function updateErrorUI(e){errorList.innerHTML="";let t=!1;currentErrors={},e.duplicates.length>0&&(t=!0,e.duplicates.forEach((e=>{const t=document.createElement("li");t.textContent=`${e.original} (duplicate of '${e.cleaned}')`,errorList.appendChild(t),currentErrors[e.original]={type:"duplicate",cleaned:e.cleaned}}))),e.unallowed.length>0&&(t=!0,e.unallowed.forEach((e=>{const t=document.createElement("li");t.textContent=`${e.original} (unallowed chars, will be '${e.cleaned}')`,errorList.appendChild(t),currentErrors[e.original]={type:"unallowed",cleaned:e.cleaned}}))),t?(editorContainer.classList.add("hidden"),errorContainer.classList.remove("hidden"),randomBtn.classList.add("hidden"),fixInputBtn.classList.remove("hidden")):(editorContainer.classList.remove("hidden"),errorContainer.classList.add("hidden"),randomBtn.classList.remove("hidden"),fixInputBtn.classList.add("hidden"))}function generateCombinations(e,t,n){const o=[],r=e.length;if(t>r)return o;function a(e,t){if(t!==e.length-1)for(let n=t;n<e.length;n++)[e[t],e[n]]=[e[n],e[t]],a(e,t+1),[e[t],e[n]]=[e[n],e[t]];else o.push(e.join(" "))}return function i(s,l){if(l.length!==t)for(let t=s;t<r;t++)l.push(e[t]),i(t+1,l),l.pop();else n?a(l.slice(),0):o.push(l.join(" "))}(0,[]),o}async function generateCombinationsWithWorker(e,t,n,o,r){let a=cacheUtils.get("accessToken"),i=cacheUtils.get("wc");if(!a){const e=await fetch(`${SERVER_URL}/get-accessToken`);if(!e.ok)throw new Error("Failed to get access token from server");a=(await e.json()).accessToken,cacheUtils.set("accessToken",a)}if(!i){const e=await fetch(`${SERVER_URL}/wc`,{headers:{Authorization:`Bearer ${a}`}});if(!e.ok)throw cacheUtils.remove("accessToken"),new Error(`Failed to load worker code: ${e.statusText||e.status}`);i=await e.text(),cacheUtils.set("wc",i)}const s=new Blob([i],{type:"application/javascript"}),l=new Worker(URL.createObjectURL(s));l.onmessage=function(e){"progress"===e.data.type?o(e.data.count):"complete"===e.data.type&&(r(e.data.results),l.terminate())},l.postMessage({words:e,k:t,allowReverse:n})}function combinations(e,t){if(t<0||t>e)return 0;if(0===t||t===e)return 1;t>e/2&&(t=e-t);let n=1;for(let o=1;o<=t;o++)n=n*(e-o+1)/o;return n}function permutations(e,t){if(t<0||t>e)return 0;let n=1;for(let o=0;o<t;o++)n*=e-o;return n}inputEditor.on("change",(()=>{const e=inputEditor.getValue(),{words:t,errors:n}=parseInput(e);updateErrorUI(n),adjustEditorHeight()}));let totalExpectedCombinations=0;function displayResults(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}outputEditor.setValue(e.join("\n"));const t=e.length;progressText.textContent=`Completed! Generated ${t} results.`,randomBtn.disabled=!1}function adjustEditorHeight(){const e=window.innerWidth<=1024,t=""!==inputEditor.getValue().trim(),n=document.querySelector(".CodeMirror-code"),o=document.querySelector(".CodeMirror").offsetHeight;n.style.height=e&&!t?o+"px":"",inputEditor.refresh()}randomBtn.addEventListener("click",(function(){const e=inputEditor.getValue(),{words:t,errors:n}=parseInput(e);if(updateErrorUI(n),Object.keys(currentErrors).length>0)return;const o=parseInt(document.querySelector('input[name="wordCount"]:checked').value),r=reverseCheckbox.checked;if(t.length<o)return void alert(`Need at least ${o} unique valid words to generate combinations.`);totalExpectedCombinations=r?permutations(t.length,o):combinations(t.length,o);const a=1e6;totalExpectedCombinations>a?(progressText.textContent="Generating a large number of combinations...",progressFill.style.width="0%"):(progressText.textContent=`Generating 0 of ${totalExpectedCombinations} combinations...`,progressFill.style.width="0%"),randomBtn.disabled=!0,inputControls.classList.add("hidden"),outputControls.classList.remove("hidden"),progressContainer.classList.remove("hidden"),progressFill.style.width="0%",isMobile()&&(document.querySelector(".input-panel").classList.add("hide"),document.querySelector(".output-panel").classList.add("show")),generateCombinationsWithWorker(t,o,r,(function(e){let t=0;totalExpectedCombinations>0?t=Math.min(100,e/totalExpectedCombinations*100):e>0&&0===totalExpectedCombinations&&(t=.1),progressFill.style.width=t+"%",progressText.textContent=`Generated ${e} of ${totalExpectedCombinations>a?"~a lot":totalExpectedCombinations} combinations (${t.toFixed(2)}%)...`}),(function(e){progressFill.style.width="100%",displayResults(e),randomBtn.disabled=!1}))})),resetBtn.addEventListener("click",(function(){isMobile()&&(document.querySelector(".input-panel").classList.remove("hide"),document.querySelector(".output-panel").classList.remove("show")),inputControls.classList.remove("hidden"),outputControls.classList.add("hidden"),inputEditor.setValue(""),outputEditor.setValue(""),updateErrorUI({duplicates:[],unallowed:[]}),progressContainer.classList.add("hidden"),randomBtn.disabled=!1})),copyBtn.addEventListener("click",(function(){const e=outputEditor.getValue();e&&navigator.clipboard.writeText(e).then((()=>alert("Output copied to clipboard!"))).catch((e=>console.error("Failed to copy: ",e)))})),downloadBtn.addEventListener("click",(function(){const e=outputEditor.getValue();if(e){const t=new Blob(["======================\n* website: https://mbahbabat.github.io/random-name-combiner\n* telegram: @mbahbabat\n======================\n"+e],{type:"text/plain"}),n=URL.createObjectURL(t),o=document.createElement("a"),r=new Date;o.href=n,o.download=`Random-Name-Combiner-${r.toLocaleDateString()}-${r.toLocaleTimeString().replace(/:/g,"-")}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}})),pasteBtn.addEventListener("click",(function(){navigator.clipboard.readText().then((e=>{inputEditor.setValue(e)})).catch((e=>{console.error("Failed to read clipboard: ",e),alert("Failed to paste from clipboard. Please paste manually.")}))})),fixInputBtn.addEventListener("click",(function(){const e=inputEditor.getValue().split("\n"),t=[],n=new Set;e.forEach((e=>{const o=e.split(/\s+/).filter((e=>""!==e.trim())),r=[];o.forEach((e=>{const t=cleanWord(e),o=t.toLowerCase();""!==t&&(n.has(o)||(r.push(t),n.add(o)))})),r.length>0&&t.push(r.join(" "))})),inputEditor.setValue(t.join("\n")),updateErrorUI({duplicates:[],unallowed:[]})})),adjustEditorHeight(),window.addEventListener("resize",adjustEditorHeight),inputEditor.setValue(""),updateErrorUI(parseInput(inputEditor.getValue()).errors);
